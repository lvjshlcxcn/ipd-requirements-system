# 投票流程图

## 完整投票流程

```
┌──────────────────────────────────────────────────────────────┐
│                        用户操作层                            │
└──────────────────────────────────────────────────────────────┘
                            ↓
                    用户点击"投票"按钮
                            ↓
                    ┌───────────────┐
                    │ 前端权限检查   │
                    │ canVote?      │
                    └───────┬───────┘
                            ↓
                     YES/NO
           ┌────────────────┴────────────────┐
           ↓                                  ↓
        禁用按钮，显示"已投票"              发送HTTP请求
           (如果已投票)                           
                                                    
┌──────────────────────────────────────────────────────────────┐
│                        API层（后端）                          │
└──────────────────────────────────────────────────────────────┘
                            ↓
        POST /api/v1/review-meetings/{meeting_id}/requirements/{requirement_id}/vote
                            ↓
                    ┌───────────────┐
                    │ 检查1: 登录？   │
                    └───────┬───────┘
                            ↓
                     NO/YES
              ┌─────────┴─────────┐
              ↓                   ↓
        返回 401             继续检查
        "需要登录"               
                            ↓
                    ┌───────────────┐
                    │ 检查2: 已投票？ │
                    └───────┬───────┘
                            ↓
                     YES/NO
       ┌─────────────────────┴─────────────────────┐
       ↓                                         ↓
返回 400,                                  继续检查
"您已经投过票了"                                 
                            ↓
                    ┌───────────────┐
                    │ 检查3: 权限？   │
                    │ can_vote()    │
                    └───────┬───────┘
                            ↓
                     NO/YES
       ┌─────────────────────┴─────────────────────┐
       ↓                                         ↓
返回 403,                                  继续检查
"没有投票权限"                                    
                            ↓
┌──────────────────────────────────────────────────────────────┐
│                    Service层（业务逻辑）                      │
└──────────────────────────────────────────────────────────────┘
                            ↓
                    ┌───────────────┐
                    │ 检查会议状态   │
                    │ in_progress?   │
                    └───────┬───────┘
                            ↓
                     NO/YES
       ┌─────────────────────┴─────────────────────┐
       ↓                                         ↓
    返回 False                                  继续检查
(403错误)                                          
                            ↓
                    ┌───────────────┐
                    │ 检查参会人员   │
                    │ is_attendee?  │
                    └───────┬───────┘
                            ↓
                     NO/YES
       ┌─────────────────────┴─────────────────────┐
       ↓                                         ↓
    返回 False                                  返回 True
(403错误)                                    (允许投票)
                            ↓
┌──────────────────────────────────────────────────────────────┐
│                  Repository层（数据访问）                      │
└──────────────────────────────────────────────────────────────┘
                            ↓
                ┌──────────────────┐
                │ 执行投票操作       │
                │ cast_vote()       │
                └────┬──────────────┘
                     ↓
          查询现有投票记录
                     ↓
              ┌─────┴─────┐
              ↓           ↓
         已有投票     无投票
              ↓           ↓
         ┌────┴────┐   创建新投票
         ↓           ↓
    API已阻止    INSERT INTO
    (不会执行)   requirement_review_votes
                     ↓
              数据库提交
              db.commit()
                     ↓
┌──────────────────────────────────────────────────────────────┐
│                      数据库层                               │
└──────────────────────────────────────────────────────────────┘
                            ↓
                ┌────────────────┐
                │ 唯一约束检查     │
                │ UNIQUE(meeting, │
                │     requirement, │
                │      voter)     │
                └────┬───────────┘
                     ↓
              ┌─────┴──────┐
              ↓            ↓
        违反约束       约束满足
         重复投票        投票成功
              ↓            ↓
          抛出异常      COMMIT成功
              ↓            ↓
    返回400错误      返回投票记录
    到Repository      到Service
                     ↓
┌──────────────────────────────────────────────────────────────┐
│                      返回结果                               │
└──────────────────────────────────────────────────────────────┘
                            ↓
        ┌──────────────────┴──────────────────┐
        ↓                                     ↓
    成功（200）                          失败（400/403/401）
        ↓                                     ↓
返回投票结果                           返回错误消息
        ↓                                     ↓
┌──────────────────────────────────────────────────────────────┐
│                      前端更新                                 │
└──────────────────────────────────────────────────────────────┘
                            ↓
                    显示成功消息
                    更新按钮状态
                    禁用投票按钮
                    显示"已投票"
                            ↓
                5秒后自动刷新统计
                    (refetchInterval: 5000)
                            ↓
              更新投票统计显示
```

## 权限检查详细流程

```
can_vote() 方法检查流程:
                            
    输入: meeting_id, user_id, requirement_id
               ↓
    ┌──────────────────────────┐
    │ 获取会议信息             │
    │ repo.get(meeting_id)    │
    └──────┬───────────────────┘
           ↓
    会议存在？
    ┌────┴────┐
    NO ↓     ↓ YES
  False    检查状态
    ↓        ↓
返回False  status == "in_progress"?
         ┌────┴────┐
         NO ↓     ↓ YES
       False    检查参会人员
         ↓        ↓
     False    is_attendee(meeting_id, user_id)?
             ┌────┴────┐
             NO ↓     ↓ YES
           False    返回 True
```

## 数据存储流程

```
投票数据模型:

requirement_review_votes 表:
┌────────────┬───────────────┬──────────┬─────────┬─────────────┐
│ meeting_id │ requirement_id│ voter_id │ vote_   │  comment    │
│    (INT)   │     (INT)     │  (INT)   │ option  │  (TEXT)     │
├────────────┼───────────────┼──────────┼─────────┼─────────────┤
│     60     │      20       │    1     │ approve │  重要需求    │
│     60     │      20       │    4     │ reject  │  需要修改    │
│     60     │      20       │    3     │ abstain │  保持中立    │
└────────────┴───────────────┴──────────┴─────────┴─────────────┘
              ↓
    唯一约束: UNIQUE(meeting_id, requirement_id, voter_id)
              ↓
      保证: 每个用户对每个需求只能投一次票
```

## 错误处理流程

```
投票失败场景:

1. 未登录 (401)
   用户未提供token → get_current_user_sync()返回None → 返回401

2. 已投票 (400)
   数据库查询到已有投票记录 → 返回400 "已经投过票了"

3. 会议未开始 (403)
   meeting.status != "in_progress" → can_vote()返回False → 返回403

4. 非参会人员 (403)
   user_id不在attendee列表 → can_vote()返回False → 返回403

5. 数据库错误 (500)
   唯一约束违反 → IntegrityError → 返回500
```

## 统计更新流程

```
投票成功后:
    ↓
前端立即更新:
  - 禁用投票按钮
  - 显示"已投票"
  - 显示投票选项
    ↓
5秒后自动刷新:
    ↓
TanStack Query触发:
    queryClient.invalidateQueries(['voteStatistics'])
    ↓
重新获取统计:
  GET /api/v1/review-meetings/60/requirements/20/votes
    ↓
后端计算统计:
  - SELECT vote_option, COUNT(*) GROUP BY vote_option
  - 计算百分比
    ↓
返回统计结果:
    ↓
前端更新显示:
  - 更新进度条
  - 更新百分比
  - 更新投票人列表
```

---

**流程图版本**: 1.0  
**最后更新**: 2026-02-05  
**作者**: Claude + TDD Agent
