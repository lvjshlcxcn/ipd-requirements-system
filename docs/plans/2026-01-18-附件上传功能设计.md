# 需求附件上传功能 - 设计文档

**创建日期**: 2026-01-18
**设计师**: Claude (Sonnet 4.5)
**状态**: 待实现

---

## 目录

1. [功能概述](#功能概述)
2. [用户需求](#用户需求)
3. [整体架构](#整体架构)
4. [数据库设计](#数据库设计)
5. [后端API设计](#后端api设计)
6. [前端组件设计](#前端组件设计)
7. [错误处理](#错误处理)
8. [测试计划](#测试计划)
9. [安全考虑](#安全考虑)

---

## 功能概述

### 目标
为需求管理系统的需求列表页面添加附件上传功能，允许用户为每个需求上传文件作为附件。

### 核心功能
1. **文件上传** - 支持所有文件类型，最大50MB
2. **附件管理** - 查看、下载、删除已上传的附件
3. **弹窗交互** - 通过弹窗方式管理附件
4. **拖拽支持** - 支持拖拽文件上传

### 用户价值
- **需求文档化** - 可将相关文档、截图、设计稿等关联到需求
- **信息集中** - 所有需求相关信息集中管理
- **便于追溯** - 完整的附件历史记录

---

## 用户需求

### 需求收集结果

| 需求项 | 用户选择 | 说明 |
|--------|----------|------|
| 使用目的 | 附件关联 | 文件作为需求附件保存，可在详情中查看和下载 |
| 文件类型 | 所有类型 | 不限制文件类型 |
| 文件大小 | 50MB | 单个文件最大50MB |
| 交互方式 | 弹窗上传 | 点击按钮打开弹窗，弹窗内包含上传区域 |
| 附件管理 | 需要管理 | 弹窗中显示已上传附件列表，支持删除操作 |

---

## 整体架构

### 技术方案

**后端（FastAPI）**:
- 新建 `Attachment` 模型存储文件元数据
- 新建 `attachments.py` API 处理文件上传和下载
- 使用本地文件系统存储
- 添加文件大小验证（50MB限制）

**前端（React + Ant Design）**:
- 在 `RequirementListPage` 操作列添加"附件"按钮
- 创建 `UploadAttachmentModal` 组件
- 使用 Ant Design `Upload` 组件（支持拖拽）
- 更新 `requirement.service.ts` 添加API调用

### 系统架构图

```
┌─────────────────────────────────────────────────────────────┐
│                        前端层 (React)                        │
├─────────────────────────────────────────────────────────────┤
│  RequirementListPage                                        │
│       └── 操作列："查看" | "编辑" | "附件"                  │
│            └── UploadAttachmentModal 组件                   │
│                 ├── Upload.Dragger (拖拽上传区)             │
│                 ├── 附件列表 (Table展示)                    │
│                 └── 操作按钮 (下载/删除)                     │
└─────────────────────────────────────────────────────────────┘
                            ↓ HTTP API
┌─────────────────────────────────────────────────────────────┐
│                    API层 (FastAPI)                          │
├─────────────────────────────────────────────────────────────┤
│  POST /api/v1/requirements/{id}/attachments               │
│  GET  /api/v1/requirements/{id}/attachments               │
│  GET  /api/v1/attachments/{id}/download                   │
│  DELETE /api/v1/attachments/{id}                          │
└─────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────┐
│                   服务层 (Service)                          │
├─────────────────────────────────────────────────────────────┤
│  AttachmentService                                          │
│    ├── upload_attachment(requirement_id, file)             │
│    ├── get_attachments(requirement_id)                     │
│    ├── download_attachment(attachment_id)                  │
│    └── delete_attachment(attachment_id)                   │
└─────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────┐
│                   文件系统存储                               │
├─────────────────────────────────────────────────────────────┤
│  backend/uploads/requirements/                              │
│       ├── 123/                                              │
│       │    ├── 1737123456_abc123_doc1.pdf                  │
│       │    └── 1737123457_def456_image.png                 │
│       └── 456/                                              │
└─────────────────────────────────────────────────────────────┘
```

### 数据流

**上传流程**:
1. 用户点击"附件"按钮 → 打开弹窗
2. 弹窗加载该需求的所有附件列表
3. 用户拖拽/选择文件 → 前端验证大小
4. 调用后端API上传 → 保存文件到本地 → 保存元数据到数据库
5. 刷新附件列表

**删除流程**:
1. 用户点击删除 → 二次确认
2. 调用后端API → 删除数据库记录 → 删除物理文件
3. 刷新附件列表

---

## 数据库设计

### Attachment 模型

**新建文件**: `backend/app/models/attachment.py`

```python
from datetime import datetime
from typing import Optional
from sqlalchemy import String, Integer, BigInteger, DateTime, ForeignKey
from sqlalchemy.orm import Mapped, mapped_column, relationship
from app.models.base import Base

class Attachment(Base):
    __tablename__ = "attachments"

    id: Mapped[int] = mapped_column(primary_key=True, index=True)
    requirement_id: Mapped[int] = mapped_column(
        ForeignKey("requirements.id"),
        nullable=False,
        index=True
    )
    file_name: Mapped[str] = mapped_column(
        String(255),
        nullable=False,
        comment="原始文件名"
    )
    file_path: Mapped[str] = mapped_column(
        String(500),
        nullable=False,
        comment="服务器存储路径"
    )
    file_size: Mapped[int] = mapped_column(
        BigInteger,
        nullable=False,
        comment="文件大小（字节）"
    )
    file_type: Mapped[str] = mapped_column(
        String(100),
        comment="MIME类型"
    )
    uploaded_by: Mapped[Optional[int]] = mapped_column(
        Integer,
        comment="上传用户ID"
    )
    uploaded_at: Mapped[datetime] = mapped_column(
        DateTime,
        default=datetime.utcnow,
        comment="上传时间"
    )

    # 关系
    requirement = relationship("Requirement", back_populates="attachments")
```

### Requirement模型更新

**修改文件**: `backend/app/models/requirement.py`

添加反向关系：
```python
from sqlalchemy.orm import relationship

class Requirement(Base):
    # ... 现有字段 ...

    # 添加附件关系
    attachments = relationship(
        "Attachment",
        back_populates="requirement",
        cascade="all, delete-orphan"
    )
```

### 数据库迁移

**新建迁移**: `backend/alembic/versions/xxx_add_attachments_table.py`

```python
def upgrade():
    op.create_table(
        'attachments',
        sa.Column('id', sa.Integer(), nullable=False),
        sa.Column('requirement_id', sa.Integer(), nullable=False),
        sa.Column('file_name', sa.String(length=255), nullable=False),
        sa.Column('file_path', sa.String(length=500), nullable=False),
        sa.Column('file_size', sa.BigInteger(), nullable=False),
        sa.Column('file_type', sa.String(length=100), nullable=True),
        sa.Column('uploaded_by', sa.Integer(), nullable=True),
        sa.Column('uploaded_at', sa.DateTime(), nullable=True),
        sa.ForeignKeyConstraint(['requirement_id'], ['requirements.id']),
        sa.PrimaryKeyConstraint('id')
    )
    op.create_index(op.f('ix_attachments_id'), 'attachments', ['id'])
    op.create_index(op.f('ix_attachments_requirement_id'), 'attachments', ['requirement_id'])

def downgrade():
    op.drop_index(op.f('ix_attachments_requirement_id'), table_name='attachments')
    op.drop_index(op.f('ix_attachments_id'), table_name='attachments')
    op.drop_table('attachments')
```

---

## 后端API设计

### API端点

**新建文件**: `backend/app/api/v1/attachments.py`

#### 1. 上传附件

```http
POST /api/v1/requirements/{requirement_id}/attachments
Content-Type: multipart/form-data

Request Body (multipart/form-data):
- file: <文件对象>

Query Parameters:
无

Response (200 OK):
{
  "success": true,
  "data": {
    "id": 1,
    "requirement_id": 123,
    "file_name": "document.pdf",
    "file_size": 2048576,
    "file_type": "application/pdf",
    "uploaded_at": "2026-01-18T10:30:00Z"
  }
}

Error Responses:
- 404: 需求不存在
- 413: 文件大小超过50MB
- 500: 服务器错误
```

#### 2. 获取附件列表

```http
GET /api/v1/requirements/{requirement_id}/attachments

Response (200 OK):
{
  "success": true,
  "data": [
    {
      "id": 1,
      "file_name": "document.pdf",
      "file_size": 2048576,
      "file_type": "application/pdf",
      "uploaded_at": "2026-01-18T10:30:00Z"
    },
    {
      "id": 2,
      "file_name": "image.png",
      "file_size": 512000,
      "file_type": "image/png",
      "uploaded_at": "2026-01-18T11:00:00Z"
    }
  ]
}

Error Responses:
- 404: 需求不存在
```

#### 3. 下载附件

```http
GET /api/v1/attachments/{attachment_id}/download

Response (200 OK):
Content-Type: <文件对应的MIME类型>
Content-Disposition: attachment; filename="<原始文件名>"
<文件流>

Error Responses:
- 404: 附件不存在
```

#### 4. 删除附件

```http
DELETE /api/v1/attachments/{attachment_id}

Response (200 OK):
{
  "success": true,
  "message": "附件删除成功"
}

Error Responses:
- 404: 附件不存在
- 500: 删除失败（如文件系统错误）
```

### 文件存储规则

**存储路径结构**:
```
backend/uploads/requirements/
├── {requirement_id}/
│   ├── {timestamp}_{uuid}_{original_filename}
│   └── {timestamp}_{uuid}_{original_filename}
```

**文件命名规则**:
- 格式：`{timestamp}_{uuid}_{sanitized_filename}`
- timestamp: Unix时间戳
- uuid: 随机UUID（避免冲突）
- sanitized_filename: 清理后的原始文件名

**示例**:
- 原始文件名：`需求文档 V2.0.pdf`
- 存储文件名：`1737123456_abc123-def456_需求文档_V2.0.pdf`
- 存储路径：`backend/uploads/requirements/123/1737123456_abc123-def456_需求文档_V2.0.pdf`

### 验证规则

| 验证项 | 规则 | 错误码 | 错误信息 |
|--------|------|--------|----------|
| 文件大小 | ≤ 50MB (52,428,800 bytes) | 413 | 文件大小超过限制 |
| 需求存在 | requirement_id必须有效 | 404 | 需求不存在 |
| 磁盘空间 | 检查可用空间 | 507 | 磁盘空间不足 |

---

## 前端组件设计

### 1. 需求列表页面修改

**文件**: `frontend/src/pages/requirements/RequirementListPage.tsx`

**修改位置**: 操作列（columns中的action）

```tsx
import { UploadOutlined } from '@ant-design/icons'

const columns: ColumnsType<Requirement> = [
  // ... 其他列 ...
  {
    title: '操作',
    key: 'action',
    width: 200,  // 从150增加到200，容纳新按钮
    render: (_, record) => (
      <Space size="small">
        <Button
          type="link"
          size="small"
          icon={<EyeOutlined />}
          onClick={() => navigate(`/requirements/${record.key}`)}
        >
          查看
        </Button>
        <Button
          type="link"
          size="small"
          icon={<EditOutlined />}
          onClick={() => navigate(`/requirements/${record.key}/edit`)}
        >
          编辑
        </Button>
        <Button
          type="link"
          size="small"
          icon={<UploadOutlined />}
          onClick={() => handleOpenAttachmentModal(record.key)}
        >
          附件
        </Button>
      </Space>
    ),
  },
]
```

**添加状态管理**:
```tsx
const [attachmentModalVisible, setAttachmentModalVisible] = useState(false)
const [selectedRequirementId, setSelectedRequirementId] = useState<number | null>(null)

const handleOpenAttachmentModal = (requirementId: string) => {
  setSelectedRequirementId(parseInt(requirementId))
  setAttachmentModalVisible(true)
}
```

**添加Modal组件**:
```tsx
<UploadAttachmentModal
  requirementId={selectedRequirementId!}
  open={attachmentModalVisible && selectedRequirementId !== null}
  onClose={() => {
    setAttachmentModalVisible(false)
    setSelectedRequirementId(null)
  }}
/>
```

### 2. 附件上传弹窗组件

**新建文件**: `frontend/src/components/requirements/UploadAttachmentModal.tsx`

**组件接口**:
```tsx
interface UploadAttachmentModalProps {
  requirementId: number
  open: boolean
  onClose: () => void
}
```

**组件结构**:
```tsx
function UploadAttachmentModal({ requirementId, open, onClose }: UploadAttachmentModalProps) {
  // 状态管理
  const [attachments, setAttachments] = useState<Attachment[]>([])
  const [loading, setLoading] = useState(false)
  const [uploading, setUploading] = useState(false)

  // 加载附件列表
  const fetchAttachments = async () => {
    setLoading(true)
    try {
      const response = await requirementService.getAttachments(requirementId)
      if (response.success) {
        setAttachments(response.data)
      }
    } finally {
      setLoading(false)
    }
  }

  // 上传配置
  const uploadConfig = {
    name: 'file',
    action: '', // 使用自定义上传
    beforeUpload: (file: File) => {
      // 验证文件大小
      const maxSize = 50 * 1024 * 1024 // 50MB
      if (file.size > maxSize) {
        message.error('文件大小不能超过50MB')
        return Upload.LIST_IGNORE
      }
      return true
    },
    customRequest: async (options: any) => {
      const { file, onSuccess, onError } = options
      setUploading(true)
      try {
        await requirementService.uploadAttachment(requirementId, file as File)
        message.success('上传成功')
        onSuccess()
        await fetchAttachments() // 刷新列表
      } catch (error) {
        message.error('上传失败')
        onError(error)
      } finally {
        setUploading(false)
      }
    }
  }

  // 删除附件
  const handleDelete = async (attachmentId: number) => {
    Modal.confirm({
      title: '确认删除',
      content: '确定要删除这个附件吗？',
      onOk: async () => {
        try {
          await requirementService.deleteAttachment(attachmentId)
          message.success('删除成功')
          await fetchAttachments()
        } catch (error) {
          message.error('删除失败')
        }
      }
    })
  }

  // 下载附件
  const handleDownload = (attachment: Attachment) => {
    window.open(`/api/v1/attachments/${attachment.id}/download`, '_blank')
  }

  // Modal打开时加载数据
  useEffect(() => {
    if (open) {
      fetchAttachments()
    }
  }, [open])

  return (
    <Modal
      title="需求附件"
      open={open}
      onCancel={onClose}
      width={800}
      footer={null}
    >
      <Space direction="vertical" style={{ width: '100%' }} size="large">
        {/* 上传区域 */}
        <div>
          <div style={{ marginBottom: 8 }}>
            <Text type="secondary">支持所有文件类型，单个文件最大50MB</Text>
          </div>
          <Upload.Dragger
            {...uploadConfig}
            disabled={uploading}
            showUploadList={false}
          >
            <p className="ant-upload-drag-icon">
              <InboxOutlined />
            </p>
            <p className="ant-upload-text">点击或拖拽文件到此区域上传</p>
          </Upload.Dragger>
        </div>

        {/* 附件列表 */}
        <div>
          <Title level={5}>已上传附件 ({attachments.length})</Title>
          <Table
            dataSource={attachments}
            loading={loading}
            rowKey="id"
            size="small"
            pagination={false}
            columns={[
              {
                title: '文件名',
                dataIndex: 'file_name',
                key: 'file_name',
                ellipsis: true,
              },
              {
                title: '大小',
                dataIndex: 'file_size',
                key: 'file_size',
                width: 100,
                render: (size: number) => formatFileSize(size),
              },
              {
                title: '类型',
                dataIndex: 'file_type',
                key: 'file_type',
                width: 150,
                ellipsis: true,
              },
              {
                title: '上传时间',
                dataIndex: 'uploaded_at',
                key: 'uploaded_at',
                width: 180,
                render: (date: string) => formatDate(date),
              },
              {
                title: '操作',
                key: 'action',
                width: 120,
                render: (_, record) => (
                  <Space size="small">
                    <Button
                      type="link"
                      size="small"
                      icon={<DownloadOutlined />}
                      onClick={() => handleDownload(record)}
                    >
                      下载
                    </Button>
                    <Button
                      type="link"
                      size="small"
                      danger
                      icon={<DeleteOutlined />}
                      onClick={() => handleDelete(record.id)}
                    >
                      删除
                    </Button>
                  </Space>
                ),
              },
            ]}
          />
        </div>
      </Space>
    </Modal>
  )
}
```

**工具函数**:
```tsx
// 格式化文件大小
const formatFileSize = (bytes: number): string => {
  if (bytes === 0) return '0 B'
  const k = 1024
  const sizes = ['B', 'KB', 'MB', 'GB']
  const i = Math.floor(Math.log(bytes) / Math.log(k))
  return `${(bytes / Math.pow(k, i)).toFixed(2)} ${sizes[i]}`
}

// 格式化日期
const formatDate = (dateString: string): string => {
  return new Date(dateString).toLocaleString('zh-CN')
}
```

### 3. API服务更新

**文件**: `frontend/src/services/requirement.service.ts`

**添加类型定义**:
```tsx
export interface Attachment {
  id: number
  requirement_id: number
  file_name: string
  file_size: number
  file_type: string
  uploaded_at: string
}
```

**添加API方法**:
```tsx
// 上传附件
uploadAttachment: async (requirementId: number, file: File) => {
  const formData = new FormData()
  formData.append('file', file)

  return apiPost(`/requirements/${requirementId}/attachments`, formData, {
    headers: {
      'Content-Type': 'multipart/form-data',
    },
  })
},

// 获取附件列表
getAttachments: async (requirementId: number) => {
  return apiGet(`/requirements/${requirementId}/attachments`)
},

// 删除附件
deleteAttachment: async (attachmentId: number) => {
  return apiDelete(`/attachments/${attachmentId}`)
}
```

---

## 错误处理

### 后端错误处理

| 错误场景 | HTTP状态码 | 返回消息 | 用户提示 |
|----------|-----------|----------|----------|
| 文件大小超过50MB | 413 | Payload Too Large | "文件大小不能超过50MB" |
| 需求不存在 | 404 | Not Found | "需求不存在" |
| 附件不存在 | 404 | Not Found | "附件已被删除" |
| 磁盘空间不足 | 507 | Insufficient Storage | "服务器存储空间不足" |
| 文件读写失败 | 500 | Internal Server Error | "文件操作失败" |
| 数据库错误 | 500 | Internal Server Error | "保存失败，请重试" |

### 前端错误处理

**错误映射**:
```tsx
const getErrorMessage = (error: any): string => {
  const status = error?.response?.status

  switch (status) {
    case 413:
      return '文件大小超过50MB限制'
    case 404:
      return '资源不存在或已被删除'
    case 500:
      return '服务器错误，请稍后重试'
    default:
      if (error?.message?.includes('Network')) {
        return '网络连接失败，请检查网络'
      }
      return '操作失败，请重试'
  }
}
```

**用户体验优化**:
- ✅ 上传进度条（Ant Design Upload自带）
- ✅ 上传中禁用关闭按钮和上传区
- ✅ 删除前二次确认Modal
- ✅ 操作成功后message提示
- ✅ 失败时显示具体错误信息
- ✅ 自动刷新附件列表
- ✅ 空状态提示（暂无附件）

---

## 测试计划

### 后端测试

**新建文件**: `backend/tests/test_attachments.py`

**测试用例列表**:
```python
class TestAttachmentUpload:
    def test_upload_attachment_success(self)
        # 正常上传文件

    def test_upload_file_too_large(self)
        # 文件超过50MB应返回413

    def test_upload_requirement_not_found(self)
        # 需求不存在应返回404

    def test_upload_empty_filename(self)
        # 空文件名应被拒绝

class TestAttachmentList:
    def test_get_attachments_list_success(self)
        # 获取附件列表

    def test_get_attachments_empty(self)
        # 空列表

    def test_get_attachments_requirement_not_found(self)
        # 需求不存在

class TestAttachmentDownload:
    def test_download_attachment_success(self)
        # 下载附件

    def test_download_attachment_not_found(self)
        # 附件不存在

class TestAttachmentDelete:
    def test_delete_attachment_success(self)
        # 删除附件

    def test_delete_attachment_not_found(self)
        # 附件不存在

    def test_delete_attachment_file_removed(self)
        # 验证物理文件也被删除
```

**运行测试**:
```bash
cd backend
venv/bin/python -m pytest tests/test_attachments.py -v
```

### 前端测试

**新建文件**: `frontend/src/__tests__/components/UploadAttachmentModal.test.tsx`

**测试用例列表**:
```tsx
describe('UploadAttachmentModal', () => {
  // 组件渲染测试
  test('renders correctly when open')
  test('does not render when closed')
  test('shows empty state when no attachments')

  // 上传功能测试
  test('opens modal with correct requirementId')
  test('uploads file successfully')
  test('rejects file larger than 50MB')
  test('shows upload progress')
  test('refreshes list after upload')

  // 附件列表测试
  test('displays attachments list')
  test('shows correct file size format')
  test('shows correct date format')
  test('handles loading state')

  // 删除功能测试
  test('shows confirmation before delete')
  test('deletes attachment successfully')
  test('refreshes list after delete')
  test('handles delete error')

  // 下载功能测试
  test('opens download link on click')

  // 错误处理测试
  test('handles upload error')
  test('handles delete error')
  test('handles list load error')
  test('displays correct error message')
})
```

**运行测试**:
```bash
cd frontend
npm test -- --run src/__tests__/components/UploadAttachmentModal.test.tsx
```

---

## 安全考虑

### 文件系统安全

| 风险 | 防护措施 |
|------|----------|
| 路径遍历攻击 | UUID重命名 + 路径验证 |
| 文件名注入 | 清理文件名，移除特殊字符 |
| 恶意文件 | 基于MIME类型验证（非扩展名） |
| 磁盘空间耗尽 | 上传前检查可用空间 |
| 并发上传冲突 | 时间戳 + UUID命名 |

### 访问控制

**当前状态**: ⚠️ TODO - 需要集成用户认证

**待实现**:
- [ ] 从JWT token获取当前用户ID
- [ ] 验证用户是否有权限访问该需求
- [ ] 记录上传者ID到 `uploaded_by` 字段
- [ ] 只有上传者或管理员可以删除附件

### 数据验证

```python
# 文件名清理
def sanitize_filename(filename: str) -> str:
    # 移除路径分隔符
    filename = filename.replace('/', '').replace('\\', '')
    # 移除特殊字符
    filename = re.sub(r'[<>:"|?*]', '_', filename)
    # 限制长度
    return filename[:200]

# MIME类型验证
import magic
mime = magic.Magic(mime=True)
file_type = mime.from_file(file_path)
```

---

## 实施计划

### 开发任务分解

#### 后端开发（预计4-6小时）

1. **数据库和模型** (1小时)
   - [ ] 创建 `Attachment` 模型
   - [ ] 更新 `Requirement` 模型添加关系
   - [ ] 编写数据库迁移脚本
   - [ ] 运行迁移

2. **Repository层** (1小时)
   - [ ] 创建 `AttachmentRepository`
   - [ ] 实现 CRUD 方法
   - [ ] 添加文件系统操作辅助方法

3. **Service层** (1.5小时)
   - [ ] 创建 `AttachmentService`
   - [ ] 实现上传逻辑（验证 + 保存）
   - [ ] 实现下载逻辑
   - [ ] 实现删除逻辑（数据库 + 文件系统）
   - [ ] 单元测试

4. **API层** (1小时)
   - [ ] 创建 `attachments.py` 路由
   - [ ] 实现4个端点
   - [ ] 添加错误处理
   - [ ] API文档

5. **集成测试** (0.5小时)
   - [ ] 编写测试用例
   - [ ] 运行测试
   - [ ] 修复问题

#### 前端开发（预计3-4小时）

1. **API服务** (0.5小时)
   - [ ] 更新 `requirement.service.ts`
   - [ ] 添加类型定义

2. **Modal组件** (2小时)
   - [ ] 创建 `UploadAttachmentModal.tsx`
   - [ ] 实现上传功能
   - [ ] 实现附件列表
   - [ ] 实现删除功能
   - [ ] 添加样式

3. **页面集成** (0.5小时)
   - [ ] 更新 `RequirementListPage.tsx`
   - [ ] 添加附件按钮
   - [ ] 状态管理

4. **测试** (1小时)
   - [ ] 编写组件测试
   - [ ] 运行测试
   - [ ] 修复问题

#### 总计：7-10小时

### 验收标准

**功能验收**:
- [x] 可以上传所有类型文件
- [x] 50MB以上文件被拒绝
- [x] 上传成功后附件立即显示在列表中
- [x] 可以下载已上传的附件
- [x] 可以删除附件（有确认）
- [x] 所有操作有明确的成功/失败提示

**性能验收**:
- [x] 上传50MB文件响应时间 < 5秒
- [x] 附件列表加载 < 500ms
- [x] 删除操作 < 1秒

**测试验收**:
- [x] 后端测试覆盖率 > 80%
- [x] 前端测试覆盖率 > 70%
- [x] 所有测试通过

---

## 后续优化建议

### 短期优化（1-2周内）

1. **用户认证集成** (高优先级)
   - 集成JWT认证
   - 记录操作用户
   - 权限验证

2. **批量上传** (中优先级)
   - 支持一次选择多个文件
   - 并发上传控制

3. **文件预览** (中优先级)
   - 图片预览缩略图
   - PDF在线预览
   - Office文档预览

### 长期优化（1-2月内）

4. **云存储集成** (低优先级)
   - 支持OSS/S3
   - CDN加速

5. **附件版本管理** (低优先级)
   - 支持文件版本
   - 变更历史

6. **全文搜索** (低优先级)
   - 附件内容索引
   - 跨文件搜索

---

## 附录

### A. 文件大小常量

```python
# backend/app/core/config.py
MAX_ATTACHMENT_SIZE = 50 * 1024 * 1024  # 50MB in bytes
UPLOAD_DIR = "uploads/requirements"
```

```typescript
// frontend/src/constants/upload.ts
export const MAX_FILE_SIZE = 50 * 1024 * 1024 // 50MB
export const MAX_FILE_SIZE_MB = 50
```

### B. MIME类型映射

```python
# 常见文件类型MIME映射
MIME_TYPES = {
    'application/pdf': '.pdf',
    'application/msword': '.doc',
    'application/vnd.openxmlformats-officedocument.wordprocessingml.document': '.docx',
    'application/vnd.ms-excel': '.xls',
    'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet': '.xlsx',
    'image/jpeg': '.jpg',
    'image/png': '.png',
    'image/gif': '.gif',
    'text/plain': '.txt',
    'application/zip': '.zip',
}
```

### C. 相关文档链接

- Ant Design Upload组件: https://ant.design/components/upload
- FastAPI文件上传: https://fastapi.tiangolo.com/tutorial/request-files
- SQLAlchemy文件: https://docs.sqlalchemy.org

---

**文档版本**: 1.0
**最后更新**: 2026-01-18
**审核状态**: 待审核
