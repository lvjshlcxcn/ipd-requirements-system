# æŠ•ç¥¨APIä¿®å¤æŠ¥å‘Š

**æ—¥æœŸ**: 2026-02-04
**é—®é¢˜**: è¯„å®¡ä¸­å¿ƒæŠ•ç¥¨åŠŸèƒ½è¿”å›é”™è¯¯æ¶ˆæ¯ä¸æ˜ç¡®
**çŠ¶æ€**: âœ… å·²ä¿®å¤

---

## ğŸ” é—®é¢˜è¯Šæ–­

### å‘ç°çš„é—®é¢˜

**æ ¹æœ¬åŸå› **: æŠ•ç¥¨APIå­˜åœ¨åŒé‡æ£€æŸ¥é€»è¾‘,å¯¼è‡´é”™è¯¯æ¶ˆæ¯ä¸æ˜ç¡®

#### é—®é¢˜1: æ£€æŸ¥é¡ºåºé”™è¯¯

**ä¿®å¤å‰**:
```python
# APIå±‚ (requirement_review_meetings.py)
# 1. å…ˆè°ƒç”¨ can_vote() - å†…éƒ¨æ£€æŸ¥æ˜¯å¦å·²æŠ•ç¥¨,è¿”å›False
if not service.can_vote(meeting_id, current_user.id, requirement_id):
    raise HTTPException(status_code=403, detail="æ‚¨æ²¡æœ‰æŠ•ç¥¨æƒé™...")

# 2. å†æ£€æŸ¥æ˜¯å¦å·²æŠ•ç¥¨ - ä½†æ°¸è¿œä¸ä¼šæ‰§è¡Œåˆ°
existing_vote = repo.get_user_vote(...)
if existing_vote:
    raise HTTPException(status_code=400, detail="æ‚¨å·²ç»æŠ•è¿‡ç¥¨äº†...")
```

**é—®é¢˜**:
- å¦‚æœç”¨æˆ·å·²æŠ•ç¥¨,`can_vote()` è¿”å› `False`
- è§¦å‘ 403 é”™è¯¯:"æ‚¨æ²¡æœ‰æŠ•ç¥¨æƒé™(éæŒ‡å®šæŠ•ç¥¨äººå‘˜ã€å·²æŠ•ç¥¨æˆ–ä¼šè®®æœªè¿›è¡Œä¸­)"
- ç”¨æˆ·æ— æ³•åŒºåˆ†æ˜¯"ä¸åœ¨æŠ•ç¥¨åˆ—è¡¨"è¿˜æ˜¯"å·²ç»æŠ•è¿‡ç¥¨"

#### é—®é¢˜2: Serviceå±‚å†—ä½™æ£€æŸ¥

**Serviceå±‚** (requirement_review_meeting.py:133-136):
```python
# æ£€æŸ¥æ˜¯å¦å·²ç»æŠ•è¿‡ç¥¨
existing_vote = self.repo.get_user_vote(meeting_id, requirement_id, user_id)
if existing_vote:
    return False
```

è¿™ä¸ªæ£€æŸ¥ä¸APIå±‚é‡å¤,å¯¼è‡´ä»£ç é€»è¾‘æ··ä¹±ã€‚

---

## âœ… ä¿®å¤æ–¹æ¡ˆ

### ä¿®æ”¹1: è°ƒæ•´APIå±‚æ£€æŸ¥é¡ºåº

**æ–‡ä»¶**: `backend/app/api/v1/requirement_review_meetings.py`

**ä¿®å¤å**:
```python
# æŒ‰ä¼˜å…ˆçº§æ£€æŸ¥æƒé™ï¼Œè¿”å›æ˜ç¡®çš„é”™è¯¯æ¶ˆæ¯
# 1. é¦–å…ˆæ£€æŸ¥æ˜¯å¦å·²æŠ•è¿‡ç¥¨ï¼ˆæœ€ä¼˜å…ˆï¼‰
existing_vote = repo.get_user_vote(meeting_id, requirement_id, current_user.id)
if existing_vote:
    raise HTTPException(
        status_code=400,
        detail="æ‚¨å·²ç»æŠ•è¿‡ç¥¨äº†ï¼Œä¸èƒ½ä¿®æ”¹æŠ•ç¥¨é€‰é¡¹"
    )

# 2. ç„¶åæ£€æŸ¥å…¶ä»–æƒé™ï¼ˆä¼šè®®çŠ¶æ€ã€å‚ä¼šäººå‘˜ã€æŒ‡å®šæŠ•ç¥¨äººï¼‰
if not service.can_vote(meeting_id, current_user.id, requirement_id):
    raise HTTPException(
        status_code=403,
        detail="æ‚¨æ²¡æœ‰æŠ•ç¥¨æƒé™ï¼ˆéæŒ‡å®šæŠ•ç¥¨äººå‘˜æˆ–ä¼šè®®æœªè¿›è¡Œä¸­ï¼‰"
    )
```

**æ”¹è¿›**:
- âœ… ä¼˜å…ˆæ£€æŸ¥"å·²æŠ•ç¥¨"çŠ¶æ€,è¿”å›æ˜ç¡®çš„400é”™è¯¯
- âœ… å…¶ä»–æƒé™é—®é¢˜è¿”å›403é”™è¯¯
- âœ… é”™è¯¯æ¶ˆæ¯æ¸…æ™°,ç”¨æˆ·èƒ½ç†è§£å…·ä½“åŸå› 

### ä¿®æ”¹2: ç§»é™¤Serviceå±‚å†—ä½™æ£€æŸ¥

**æ–‡ä»¶**: `backend/app/services/requirement_review_meeting.py`

**ä¿®å¤å†…å®¹**: ç§»é™¤ç¬¬133-136è¡Œçš„"å·²æŠ•ç¥¨"æ£€æŸ¥

**æ”¹è¿›**:
- âœ… é¿å…é‡å¤æ£€æŸ¥
- âœ… èŒè´£åˆ†ç¦»: Serviceå±‚æ£€æŸ¥æƒé™,APIå±‚æ£€æŸ¥ä¸šåŠ¡è§„åˆ™
- âœ… ä»£ç æ›´ç®€æ´,é€»è¾‘æ›´æ¸…æ™°

---

## ğŸ“Š ä¿®å¤å‰åå¯¹æ¯”

### åœºæ™¯: ç”¨æˆ·å·²æŠ•ç¥¨,å°è¯•å†æ¬¡æŠ•ç¥¨

#### ä¿®å¤å‰
```
è¯·æ±‚: POST /api/v1/requirement-review-meetings/45/requirements/20/vote
å“åº”:
  çŠ¶æ€ç : 403 Forbidden
  æ¶ˆæ¯: "æ‚¨æ²¡æœ‰æŠ•ç¥¨æƒé™ï¼ˆéæŒ‡å®šæŠ•ç¥¨äººå‘˜ã€å·²æŠ•ç¥¨æˆ–ä¼šè®®æœªè¿›è¡Œä¸­ï¼‰"

é—®é¢˜: ç”¨æˆ·æ— æ³•åŒºåˆ†æ˜¯æƒé™é—®é¢˜è¿˜æ˜¯å·²æŠ•ç¥¨é—®é¢˜
```

#### ä¿®å¤å
```
è¯·æ±‚: POST /api/v1/requirement-review-meetings/45/requirements/20/vote
å“åº”:
  çŠ¶æ€ç : 400 Bad Request
  æ¶ˆæ¯: "æ‚¨å·²ç»æŠ•è¿‡ç¥¨äº†ï¼Œä¸èƒ½ä¿®æ”¹æŠ•ç¥¨é€‰é¡¹"

æ”¹è¿›: âœ… æ˜ç¡®å‘ŠçŸ¥ç”¨æˆ·å·²æŠ•ç¥¨,é”™è¯¯ç ä¹Ÿæ›´åˆç† (400 vs 403)
```

---

## ğŸ§ª æµ‹è¯•åœºæ™¯

### æµ‹è¯•æ•°æ®
- **ä¼šè®®ID**: 45
- **éœ€æ±‚ID**: 20
- **æŠ•ç¥¨äººå‘˜åˆ—è¡¨**: [2, 3] (market_pm, rd_pm)

### æµ‹è¯•ç”¨ä¾‹

#### âœ… ç”¨ä¾‹1: å·²æŠ•ç¥¨ç”¨æˆ·å†æ¬¡æŠ•ç¥¨

**æ­¥éª¤**:
1. ç”¨æˆ·ID 2 (market_pm) é¦–æ¬¡æŠ•ç¥¨æˆåŠŸ
2. ä½¿ç”¨ç›¸åŒç”¨æˆ·å†æ¬¡æŠ•ç¥¨

**è¯·æ±‚**:
```bash
curl -X POST 'http://localhost:8000/api/v1/requirement-review-meetings/45/requirements/20/vote' \
  -H 'Content-Type: application/json' \
  -H 'Authorization: Bearer <ç”¨æˆ·2çš„token>' \
  -d '{"vote_option":"reject","comment":"æˆ‘æ”¹ä¸»æ„äº†"}'
```

**é¢„æœŸç»“æœ**: âœ… ä¿®å¤å
```json
{
  "detail": "æ‚¨å·²ç»æŠ•è¿‡ç¥¨äº†ï¼Œä¸èƒ½ä¿®æ”¹æŠ•ç¥¨é€‰é¡¹"
}
```
- çŠ¶æ€ç : `400 Bad Request` (è€Œä¸æ˜¯403)
- æ¶ˆæ¯æ˜ç¡®æŒ‡å‡º"å·²æŠ•ç¥¨"

---

#### âœ… ç”¨ä¾‹2: ç”¨æˆ·ä¸åœ¨æŠ•ç¥¨äººå‘˜åˆ—è¡¨ä¸­

**æ­¥éª¤**:
1. ç”¨æˆ·ID 1 (admin) å°è¯•æŠ•ç¥¨,ä½†ä¸åœ¨ `assigned_voter_ids` ä¸­

**è¯·æ±‚**:
```bash
curl -X POST 'http://localhost:8000/api/v1/requirement-review-meetings/45/requirements/20/vote' \
  -H 'Content-Type: application/json' \
  -H 'Authorization: Bearer <ç”¨æˆ·1çš„token>' \
  -d '{"vote_option":"approve","comment":"æµ‹è¯•"}'
```

**é¢„æœŸç»“æœ**:
```json
{
  "detail": "æ‚¨æ²¡æœ‰æŠ•ç¥¨æƒé™ï¼ˆéæŒ‡å®šæŠ•ç¥¨äººå‘˜æˆ–ä¼šè®®æœªè¿›è¡Œä¸­ï¼‰"
}
```
- çŠ¶æ€ç : `403 Forbidden`
- æ¶ˆæ¯æ˜ç¡®æŒ‡å‡º"éæŒ‡å®šæŠ•ç¥¨äººå‘˜"

---

#### âœ… ç”¨ä¾‹3: æŠ•ç¥¨äººå‘˜é¦–æ¬¡æŠ•ç¥¨

**æ­¥éª¤**:
1. ç”¨æˆ·ID 2 (market_pm) åœ¨ `assigned_voter_ids` ä¸­
2. è¯¥ç”¨æˆ·å°šæœªæŠ•ç¥¨

**è¯·æ±‚**:
```bash
curl -X POST 'http://localhost:8000/api/v1/requirement-review-meetings/45/requirements/20/vote' \
  -H 'Content-Type: application/json' \
  -H 'Authorization: Bearer <ç”¨æˆ·2çš„token>' \
  -d '{"vote_option":"approve","comment":"æˆ‘åŒæ„è¿™ä¸ªéœ€æ±‚"}'
```

**é¢„æœŸç»“æœ**: âœ… æˆåŠŸ
```json
{
  "success": true,
  "message": "æŠ•ç¥¨æˆåŠŸ",
  "data": {
    "id": <vote_id>,
    "meeting_id": 45,
    "requirement_id": 20,
    "voter_id": 2,
    "vote_option": "approve",
    "comment": "æˆ‘åŒæ„è¿™ä¸ªéœ€æ±‚"
  }
}
```
- çŠ¶æ€ç : `200 OK`
- æŠ•ç¥¨è®°å½•ä¿å­˜æˆåŠŸ

---

## ğŸ¯ å‰ç«¯é€‚é…

å‰ç«¯ä»£ç æ— éœ€ä¿®æ”¹,å·²ç»æ­£ç¡®å¤„ç†é”™è¯¯å“åº”:

**æ–‡ä»¶**: `frontend/src/pages/review-center/ReviewMeetingDetailPage.tsx`

```typescript
onError: (error: any) => {
  message.error(error.message || 'æŠ•ç¥¨å¤±è´¥')
}
```

**ä¿®å¤åçš„ç”¨æˆ·ä½“éªŒ**:
- å·²æŠ•ç¥¨ â†’ æ˜¾ç¤º: "æ‚¨å·²ç»æŠ•è¿‡ç¥¨äº†ï¼Œä¸èƒ½ä¿®æ”¹æŠ•ç¥¨é€‰é¡¹" âœ…
- æ— æƒé™ â†’ æ˜¾ç¤º: "æ‚¨æ²¡æœ‰æŠ•ç¥¨æƒé™ï¼ˆéæŒ‡å®šæŠ•ç¥¨äººå‘˜æˆ–ä¼šè®®æœªè¿›è¡Œä¸­ï¼‰" âœ…
- æŠ•ç¥¨æˆåŠŸ â†’ æ˜¾ç¤º: "æŠ•ç¥¨æˆåŠŸ" âœ…

---

## ğŸ“ APIé”™è¯¯ç è¯´æ˜

| çŠ¶æ€ç  | åœºæ™¯ | é”™è¯¯æ¶ˆæ¯ |
|--------|------|---------|
| **401** | æœªç™»å½• | "éœ€è¦ç™»å½•æ‰èƒ½æŠ•ç¥¨" |
| **400** | å·²æŠ•ç¥¨ | "æ‚¨å·²ç»æŠ•è¿‡ç¥¨äº†ï¼Œä¸èƒ½ä¿®æ”¹æŠ•ç¥¨é€‰é¡¹" â­ æ–°å¢ |
| **403** | æ— æƒé™ | "æ‚¨æ²¡æœ‰æŠ•ç¥¨æƒé™ï¼ˆéæŒ‡å®šæŠ•ç¥¨äººå‘˜æˆ–ä¼šè®®æœªè¿›è¡Œä¸­ï¼‰" âœ¨ ä¼˜åŒ– |
| **200** | æˆåŠŸ | "æŠ•ç¥¨æˆåŠŸ" |

---

## âœ… éªŒè¯æ­¥éª¤

### 1. é‡å¯åç«¯æœåŠ¡

```bash
cd backend
uvicorn app.main:app --reload --host 0.0.0.0 --port 8000
```

### 2. æµ‹è¯•ç”¨ä¾‹1: å·²æŠ•ç¥¨ç”¨æˆ·å†æ¬¡æŠ•ç¥¨

```bash
# è·å–token (å‡è®¾ç”¨æˆ·æ˜¯market_pm, ID=2)
TOKEN="<your_token>"

# é¦–æ¬¡æŠ•ç¥¨
curl -X POST 'http://localhost:8000/api/v1/requirement-review-meetings/45/requirements/20/vote' \
  -H "Authorization: Bearer $TOKEN" \
  -H 'Content-Type: application/json' \
  -d '{"vote_option":"approve","comment":"é¦–æ¬¡æŠ•ç¥¨"}'

# å†æ¬¡æŠ•ç¥¨ (åº”è¯¥è¿”å›400)
curl -X POST 'http://localhost:8000/api/v1/requirement-review-meetings/45/requirements/20/vote' \
  -H "Authorization: Bearer $TOKEN" \
  -H 'Content-Type: application/json' \
  -d '{"vote_option":"reject","comment":"ä¿®æ”¹æŠ•ç¥¨"}'
```

**é¢„æœŸ**: ç¬¬äºŒæ¬¡è¯·æ±‚è¿”å› `400` å’Œ "æ‚¨å·²ç»æŠ•è¿‡ç¥¨äº†"

### 3. æµ‹è¯•ç”¨ä¾‹2: éæŠ•ç¥¨äººå‘˜æŠ•ç¥¨

```bash
# ä½¿ç”¨ä¸åœ¨ assigned_voter_ids ä¸­çš„ç”¨æˆ·
TOKEN="<user_not_in_list_token>"

curl -X POST 'http://localhost:8000/api/v1/requirement-review-meetings/45/requirements/20/vote' \
  -H "Authorization: Bearer $TOKEN" \
  -H 'Content-Type: application/json' \
  -d '{"vote_option":"approve","comment":"æµ‹è¯•"}'
```

**é¢„æœŸ**: è¿”å› `403` å’Œ "æ‚¨æ²¡æœ‰æŠ•ç¥¨æƒé™ï¼ˆéæŒ‡å®šæŠ•ç¥¨äººå‘˜æˆ–ä¼šè®®æœªè¿›è¡Œä¸­ï¼‰"

### 4. å‰ç«¯æµ‹è¯•

1. è®¿é—®: http://localhost:5173
2. è¿›å…¥"è¯„å®¡ä¸­å¿ƒ" â†’ ä¼šè®® "RM-20260204-003"
3. é€‰æ‹©éœ€æ±‚ "REQ-2026-0016"
4. ç‚¹å‡»æŠ•ç¥¨é€‰é¡¹

**é¢„æœŸ**:
- æŠ•ç¥¨æˆåŠŸ: æ˜¾ç¤º "æŠ•ç¥¨æˆåŠŸ" âœ…
- å·²æŠ•ç¥¨: æ˜¾ç¤º "æ‚¨å·²ç»æŠ•è¿‡ç¥¨äº†ï¼Œä¸èƒ½ä¿®æ”¹æŠ•ç¥¨é€‰é¡¹" âœ…

---

## ğŸ“Š ä¿®å¤å½±å“åˆ†æ

### å½±å“èŒƒå›´
- âœ… **æœ€å°åŒ–æ”¹åŠ¨**: ä»…ä¿®æ”¹2ä¸ªæ–‡ä»¶
- âœ… **å‘åå…¼å®¹**: APIæ¥å£ä¸å˜,ä»…ä¼˜åŒ–é”™è¯¯å¤„ç†
- âœ… **æ— å‰¯ä½œç”¨**: ä¸å½±å“æ­£å¸¸æŠ•ç¥¨æµç¨‹

### æ€§èƒ½å½±å“
- âš ï¸ **æ•°æ®åº“æŸ¥è¯¢å¢åŠ 1æ¬¡**: `repo.get_user_vote()` åœ¨ `can_vote()` ä¹‹å‰æ‰§è¡Œ
- âœ… **å½±å“å¾®å°**: æŸ¥è¯¢ä½¿ç”¨ä¸»é”®ç´¢å¼•,æ€§èƒ½å¯å¿½ç•¥
- âœ… **é¿å…é‡å¤æŸ¥è¯¢**: ç§»é™¤äº†Serviceå±‚çš„é‡å¤æ£€æŸ¥

---

## ğŸ”§ æŠ€æœ¯å€ºåŠ¡æ¸…ç†

### å»ºè®®çš„åç»­ä¼˜åŒ–

1. **ç»Ÿä¸€é”™è¯¯å¤„ç†**: è€ƒè™‘åˆ›å»ºä¸“é—¨çš„å¼‚å¸¸ç±»
   ```python
   class AlreadyVotedException(HTTPException):
       def __init__(self):
           super().__init__(
               status_code=400,
               detail="æ‚¨å·²ç»æŠ•è¿‡ç¥¨äº†ï¼Œä¸èƒ½ä¿®æ”¹æŠ•ç¥¨é€‰é¡¹"
           )
   ```

2. **æ·»åŠ å•å…ƒæµ‹è¯•**: è¦†ç›–æ‰€æœ‰æŠ•ç¥¨åœºæ™¯
   ```python
   def test_cast_vote_already_voted():
       # æµ‹è¯•å·²æŠ•ç¥¨ç”¨æˆ·å†æ¬¡æŠ•ç¥¨
       pass
   ```

3. **æ–‡æ¡£æ›´æ–°**: æ›´æ–°APIæ–‡æ¡£,æ˜ç¡®é”™è¯¯ç å«ä¹‰

---

## ğŸ“‹ ä¿®æ”¹æ–‡ä»¶æ¸…å•

| æ–‡ä»¶ | ä¿®æ”¹ç±»å‹ | è¡Œæ•°å˜åŒ– |
|------|---------|---------|
| `backend/app/api/v1/requirement_review_meetings.py` | é‡æ„ | -8è¡Œ (ç§»é™¤å†—ä½™) |
| `backend/app/services/requirement_review_meeting.py` | ç®€åŒ– | -4è¡Œ (ç§»é™¤é‡å¤æ£€æŸ¥) |

---

## âœ… ç»“è®º

**ä¿®å¤çŠ¶æ€**: å®Œæˆ âœ…

**æ ¸å¿ƒæ”¹è¿›**:
1. âœ… é”™è¯¯æ¶ˆæ¯æ˜ç¡®,ç”¨æˆ·èƒ½ç†è§£å…·ä½“åŸå› 
2. âœ… HTTPçŠ¶æ€ç æ›´ç¬¦åˆè¯­ä¹‰ (400 vs 403)
3. âœ… ä»£ç é€»è¾‘æ¸…æ™°,èŒè´£åˆ†ç¦»
4. âœ… æ— ç ´åæ€§æ”¹åŠ¨,å‘åå…¼å®¹

**æµ‹è¯•çŠ¶æ€**: å¾…éªŒè¯ â³
- [ ] åç«¯APIæµ‹è¯•
- [ ] å‰ç«¯UIæµ‹è¯•
- [ ] æ•°æ®åº“éªŒè¯

---

**ä¿®å¤äººå‘˜**: Claude Code
**å®¡æ ¸**: å¾…äººå·¥æµ‹è¯•
**æ—¥æœŸ**: 2026-02-04
