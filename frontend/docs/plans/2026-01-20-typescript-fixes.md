# TypeScript 错误修复计划

## 📊 错误概览

**总计**: 123 个 TypeScript 错误

### 错误分类统计

| 错误代码 | 说明 | 数量 | 优先级 |
|---------|------|------|--------|
| TS18046 | unknown类型访问 | 34 | 🔴 高 |
| TS6133 | 未使用变量/导入 | 30 | 🟢 低 |
| TS2339 | 属性不存在 | 19 | 🔴 高 |
| TS2304 | 找不到名称 | 15 | 🔴 高 |
| TS2322 | 类型不匹配 | 9 | 🟡 中 |
| TS2741 | 缺少必需属性 | 3 | 🔴 高 |
| TS2353 | 对象字面量属性错误 | 3 | 🟡 中 |
| TS2614 | 模块导出成员错误 | 2 | 🔴 高 |
| 其他 | 各种类型错误 | 8 | 🟡 中 |

### 受影响文件 Top 10

1. RequirementEditPage.tsx - 13 个错误
2. rtm.service.test.ts - 11 个错误
3. RequirementListPage.tsx - 8 个错误
4. RequirementListPage.test.tsx - 7 个错误
5. api.ts - 6 个错误
6. AnalyticsPage.tsx - 6 个错误
7. RequirementHistoryTimeline.tsx - 6 个错误
8. RTMPage.test.tsx - 6 个错误
9. router/index.tsx - 5 个错误
10. RequirementDetailPage.tsx - 5 个错误

## 🎯 修复计划

### 阶段 1: 基础类型修复（高优先级，预计 30-45 分钟）

#### 1.1 添加 Vite 类型声明 (5 分钟)
- **文件**: `src/vite-env.d.ts` 或 `src/env.d.ts`
- **问题**: `import.meta.env` 类型未定义
- **修复**: 添加 Vite 环境变量类型声明

```typescript
/// <reference types="vite/client" />

interface ImportMetaEnv {
  readonly VITE_API_URL?: string
  // 添加其他环境变量
}

interface ImportMeta {
  readonly env: ImportMetaEnv
}
```

#### 1.2 修复 API 服务类型 (10 分钟)
- **文件**: `src/services/api.ts`
- **问题**: API 返回类型不匹配
- **修复**:
  - 添加响应类型包装
  - 修复泛型约束
  - 添加正确的类型声明

#### 1.3 修复路由类型问题 (10 分钟)
- **文件**: `src/router/index.tsx`, `src/router/routes.ts`
- **问题**:
  - VerificationChecklistForm 缺少 mode 属性
  - RouteConfig 类型不匹配
- **修复**:
  - 更新 RouteConfig 类型定义
  - 为路由传递正确的 props

#### 1.4 修复 global 类型 (5 分钟)
- **文件**: 测试文件
- **问题**: Node.js global 类型缺失
- **修复**: 添加 `@types/node` 或创建 global 类型声明

#### 1.5 修复模块导入 (5 分钟)
- **文件**: 多个服务文件
- **问题**: `import { api }` vs `import api`
- **修复**: 统一导入方式

### 阶段 2: 业务逻辑类型修复（中优先级，预计 30-45 分钟）

#### 2.1 修复 unknown 类型问题 (20 分钟)
- **文件**: RequirementEditPage.tsx, RequirementListPage.tsx 等
- **问题**: API 响应被推断为 unknown
- **修复**:
  - 添加类型断言
  - 改进 API 类型定义
  - 使用类型守卫

#### 2.2 修复组件 Props 类型 (15 分钟)
- **文件**: RequirementHistoryTimeline.tsx 等
- **问题**: Props 类型定义不完整
- **修复**:
  - 更新组件接口
  - 添加缺失的属性定义

#### 2.3 修复测试文件类型 (10 分钟)
- **文件**: 所有 .test.tsx 文件
- **问题**: Mock 类型不正确
- **修复**:
  - 更新 jest mock 类型
  - 添加类型断言

### 阶段 3: 代码清理（低优先级，预计 15-20 分钟）

#### 3.1 移除未使用的导入和变量 (15 分钟)
- **文件**: 所有 TS/TSX 文件
- **问题**: 30 个 TS6133 错误
- **修复**:
  - 删除未使用的导入
  - 删除未使用的变量
  - 或者添加 `_` 前缀表示有意未使用

#### 3.2 修复其他类型警告 (5 分钟)
- **文件**: 各种文件
- **问题**: TS2440, TS2554 等
- **修复**: 根据具体情况修复

### 阶段 4: 验证和测试（预计 15-20 分钟）

#### 4.1 类型检查验证
- 运行 `npm run build` 确保无 TypeScript 错误
- 运行 `tsc --noEmit` 进行额外检查

#### 4.2 功能测试
- 运行开发服务器
- 测试所有页面功能
- 测试路由导航
- 测试 API 调用

#### 4.3 单元测试
- 运行测试套件
- 确保所有测试通过
- 修复失败的测试

## ⚠️ 风险评估

### 修复过程中的风险
1. **类型变更可能影响运行时行为** - 需要仔细测试
2. **测试文件修复可能影响测试覆盖率** - 需要验证
3. **大规模修改可能引入新问题** - 需要逐步提交

### 缓解措施
1. ✅ **分阶段修复** - 每个阶段完成后提交
2. ✅ **保留原始代码** - 使用 git 分支管理
3. ✅ **充分测试** - 每个阶段后运行测试
4. ✅ **代码审查** - 修复完成后进行审查

## 📋 执行检查清单

### 阶段 1 检查清单
- [ ] 添加 Vite 类型声明文件
- [ ] 修复 api.ts 类型错误
- [ ] 修复路由类型问题
- [ ] 修复 global 类型问题
- [ ] 修复模块导入问题
- [ ] 运行构建验证错误减少

### 阶段 2 检查清单
- [ ] 修复所有 unknown 类型错误
- [ ] 修复组件 Props 类型
- [ ] 修复测试文件类型
- [ ] 运行构建验证错误减少

### 阶段 3 检查清单
- [ ] 移除所有未使用的导入
- [ ] 移除所有未使用的变量
- [ ] 修复其他类型警告
- [ ] 运行构建确保 0 错误

### 阶段 4 检查清单
- [ ] `npm run build` 成功
- [ ] `tsc --noEmit` 成功
- [ ] 开发服务器运行正常
- [ ] 所有页面功能正常
- [ ] 所有测试通过

## 🎯 成功标准

✅ **最终目标**:
1. TypeScript 编译 0 错误
2. 生产构建成功
3. 所有功能正常工作
4. 所有测试通过
5. 代码质量提升

## 📝 后续步骤

完成修复后：
1. ✅ 创建 git commit: `fix: 修复所有 TypeScript 类型错误`
2. ✅ 更新 CHANGELOG.md
3. ✅ 重新评估合并到 main 分支的风险
4. ✅ 如果测试通过，执行合并流程

---

**创建时间**: 2026-01-20
**预计完成时间**: 1.5 - 2 小时
**当前状态**: 📋 计划中
