<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IPDéœ€æ±‚åé—® â†’ ç”¨æˆ·æ•…äº‹ â†’ INVESTåˆ†æ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: #f0f2f5;
            color: rgba(0, 0, 0, 0.88);
            line-height: 1.6;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #1890ff 0%, #096dd9 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 14px;
            opacity: 0.9;
        }

        .steps {
            display: flex;
            justify-content: center;
            background: #fafafa;
            padding: 20px;
            border-bottom: 1px solid #f0f0f0;
        }

        .step {
            padding: 10px 20px;
            margin: 0 10px;
            border-radius: 4px;
            font-size: 14px;
            color: rgba(0, 0, 0, 0.45);
            cursor: default;
            transition: all 0.3s;
        }

        .step.active {
            background: #1890ff;
            color: white;
            font-weight: 500;
        }

        .step.completed {
            color: #52c41a;
        }

        .content {
            padding: 40px;
        }

        .section {
            display: none;
        }

        .section.active {
            display: block;
        }

        .form-group {
            margin-bottom: 24px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: rgba(0, 0, 0, 0.88);
        }

        .form-label .required {
            color: #ff4d4f;
            margin-left: 4px;
        }

        .form-label .hint {
            font-size: 12px;
            color: rgba(0, 0, 0, 0.45);
            font-weight: normal;
            margin-left: 8px;
        }

        .form-input,
        .form-textarea,
        .form-select {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #d9d9d9;
            border-radius: 4px;
            font-size: 14px;
            transition: all 0.3s;
        }

        .form-input:focus,
        .form-textarea:focus,
        .form-select:focus {
            outline: none;
            border-color: #1890ff;
            box-shadow: 0 0 0 2px rgba(24, 144, 255, 0.1);
        }

        .form-textarea {
            min-height: 80px;
            resize: vertical;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 24px;
        }

        @media (max-width: 768px) {
            .form-grid {
                grid-template-columns: 1fr;
            }
        }

        .btn {
            display: inline-block;
            padding: 10px 24px;
            border: none;
            border-radius: 4px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }

        .btn-primary {
            background: #1890ff;
            color: white;
        }

        .btn-primary:hover {
            background: #40a9ff;
        }

        .btn-secondary {
            background: white;
            border: 1px solid #d9d9d9;
            color: rgba(0, 0, 0, 0.88);
        }

        .btn-secondary:hover {
            color: #1890ff;
            border-color: #1890ff;
        }

        .btn-success {
            background: #52c41a;
            color: white;
        }

        .btn-success:hover {
            background: #73d13d;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .button-group {
            display: flex;
            gap: 12px;
            margin-top: 30px;
            justify-content: center;
        }

        /* Story Card Styles */
        .story-card {
            background: #fafafa;
            border-radius: 8px;
            padding: 30px;
            margin-bottom: 20px;
        }

        .story-title {
            font-size: 20px;
            font-weight: 600;
            color: #1890ff;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #1890ff;
        }

        .story-section {
            margin-bottom: 20px;
        }

        .story-section-title {
            font-weight: 600;
            color: rgba(0, 0, 0, 0.88);
            margin-bottom: 10px;
            display: flex;
            align-items: center;
        }

        .story-section-title .icon {
            margin-right: 8px;
            font-size: 18px;
        }

        .story-content {
            background: white;
            padding: 15px;
            border-radius: 4px;
            border-left: 3px solid #1890ff;
        }

        .acceptance-criteria {
            list-style: none;
        }

        .acceptance-criteria li {
            padding: 8px 0;
            padding-left: 30px;
            position: relative;
        }

        .acceptance-criteria li:before {
            content: "âœ“";
            position: absolute;
            left: 8px;
            color: #52c41a;
            font-weight: bold;
        }

        /* INVEST Analysis Styles */
        .invest-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        @media (max-width: 900px) {
            .invest-container {
                grid-template-columns: 1fr;
            }
        }

        .invest-controls {
            background: #fafafa;
            padding: 25px;
            border-radius: 8px;
        }

        .invest-slider-group {
            margin-bottom: 20px;
        }

        .invest-slider-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-weight: 500;
        }

        .invest-slider-value {
            color: #1890ff;
            font-weight: 600;
        }

        .invest-slider {
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: #f0f0f0;
            outline: none;
            -webkit-appearance: none;
        }

        .invest-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #1890ff;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .invest-slider::-moz-range-thumb {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #1890ff;
            cursor: pointer;
            border: none;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .invest-visualization {
            background: #fafafa;
            padding: 25px;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .radar-chart-container {
            width: 100%;
            max-width: 400px;
            aspect-ratio: 1;
        }

        .invest-score-display {
            text-align: center;
            margin-top: 20px;
        }

        .total-score {
            font-size: 48px;
            font-weight: 700;
            color: #1890ff;
        }

        .total-score.excellent {
            color: #52c41a;
        }

        .total-score.good {
            color: #faad14;
        }

        .total-score.poor {
            color: #ff4d4f;
        }

        .score-label {
            font-size: 14px;
            color: rgba(0, 0, 0, 0.45);
            margin-top: 5px;
        }

        .suggestions {
            margin-top: 30px;
            background: #fff7e6;
            border-left: 4px solid #faad14;
            padding: 15px 20px;
            border-radius: 4px;
        }

        .suggestions-title {
            font-weight: 600;
            color: #ad6800;
            margin-bottom: 10px;
        }

        .suggestions-list {
            list-style: none;
        }

        .suggestions-list li {
            padding: 5px 0;
            padding-left: 20px;
            position: relative;
            font-size: 14px;
        }

        .suggestions-list li:before {
            content: "â†’";
            position: absolute;
            left: 0;
            color: #faad14;
            font-weight: bold;
        }

        /* Export Section */
        .export-section {
            margin-top: 30px;
            padding-top: 30px;
            border-top: 1px solid #f0f0f0;
            text-align: center;
        }

        .export-section h3 {
            margin-bottom: 15px;
            color: rgba(0, 0, 0, 0.88);
        }

        /* Alert Styles */
        .alert {
            padding: 12px 20px;
            border-radius: 4px;
            margin-bottom: 20px;
        }

        .alert-info {
            background: #e6f7ff;
            border-left: 4px solid #1890ff;
            color: #0050b3;
        }

        .alert-success {
            background: #f6ffed;
            border-left: 4px solid #52c41a;
            color: #389e0d;
        }

        .alert-warning {
            background: #fffbe6;
            border-left: 4px solid #faad14;
            color: #ad6800;
        }

        /* Loading Spinner */
        .loading {
            display: inline-block;
            width: 14px;
            height: 14px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 0.6s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ¯ IPDéœ€æ±‚åé—® â†’ ç”¨æˆ·æ•…äº‹ â†’ INVESTåˆ†æ</h1>
            <p>ä»éœ€æ±‚æ”¶é›†åˆ°è´¨é‡è¯„ä¼°çš„å®Œæ•´å·¥ä½œæµ</p>
        </div>

        <div class="steps">
            <div class="step active" id="step1-indicator">1. IPDéœ€æ±‚åé—®</div>
            <div class="step" id="step2-indicator">2. ç”¨æˆ·æ•…äº‹</div>
            <div class="step" id="step3-indicator">3. INVESTåˆ†æ</div>
        </div>

        <div class="content">
            <!-- Step 1: IPD Questionnaire -->
            <div class="section active" id="step1">
                <div class="alert alert-info">
                    <strong>ğŸ’¡ æç¤ºï¼š</strong>è¯·å¡«å†™IPDéœ€æ±‚åé—®ï¼Œå¸®åŠ©æˆ‘ä»¬å…¨é¢äº†è§£éœ€æ±‚èƒŒæ™¯å’Œç»†èŠ‚ã€‚
                </div>

                <form id="ipdForm">
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label">
                                1. è°å…³å¿ƒè¿™ä¸ªéœ€æ±‚ï¼Ÿ
                                <span class="required">*</span>
                            </label>
                            <input type="text" class="form-input" id="q1_who" required
                                   placeholder="ä¾‹å¦‚ï¼šç”µå•†å¹³å°çš„å–å®¶ã€é‡‡è´­ç»ç†ã€ç³»ç»Ÿç®¡ç†å‘˜">
                        </div>

                        <div class="form-group">
                            <label class="form-label">
                                2. ä»–ä»¬ä¸ºä»€ä¹ˆå…³å¿ƒï¼Ÿ
                                <span class="required">*</span>
                            </label>
                            <textarea class="form-textarea" id="q2_why" required
                                      placeholder="æè¿°ä¸šåŠ¡ç—›ç‚¹æˆ–æœºä¼š"></textarea>
                        </div>

                        <div class="form-group">
                            <label class="form-label">
                                3. å…·ä½“é‡åˆ°äº†ä»€ä¹ˆé—®é¢˜ï¼Ÿ
                                <span class="required">*</span>
                            </label>
                            <textarea class="form-textarea" id="q3_what_problem" required
                                      placeholder="æè¿°å½“å‰é¢ä¸´çš„å…·ä½“é—®é¢˜"></textarea>
                        </div>

                        <div class="form-group">
                            <label class="form-label">
                                4. ç°åœ¨çš„è§£å†³æ–¹æ¡ˆæ˜¯ä»€ä¹ˆï¼Ÿ
                            </label>
                            <textarea class="form-textarea" id="q4_current_solution"
                                      placeholder="æè¿°ç°æœ‰çš„è§£å†³æ–¹æ¡ˆæˆ–å·¥ä½œæµç¨‹"></textarea>
                        </div>

                        <div class="form-group">
                            <label class="form-label">
                                5. å½“å‰æ–¹æ¡ˆæœ‰ä»€ä¹ˆé—®é¢˜ï¼Ÿ
                            </label>
                            <textarea class="form-textarea" id="q5_current_issues"
                                      placeholder="åˆ—å‡ºå½“å‰æ–¹æ¡ˆå­˜åœ¨çš„ç—›ç‚¹"></textarea>
                        </div>

                        <div class="form-group">
                            <label class="form-label">
                                6. ç†æƒ³çš„è§£å†³æ–¹æ¡ˆæ˜¯ä»€ä¹ˆï¼Ÿ
                                <span class="required">*</span>
                            </label>
                            <textarea class="form-textarea" id="q6_ideal_solution" required
                                      placeholder="æè¿°æœŸæœ›çš„è§£å†³æ–¹æ¡ˆ"></textarea>
                        </div>

                        <div class="form-group">
                            <label class="form-label">
                                7. ä¼˜å…ˆçº§
                                <span class="required">*</span>
                            </label>
                            <select class="form-select" id="q7_priority" required>
                                <option value="">è¯·é€‰æ‹©ä¼˜å…ˆçº§</option>
                                <option value="high">é«˜ - å¿…é¡»å®ç°</option>
                                <option value="medium">ä¸­ - åº”è¯¥å®ç°</option>
                                <option value="low">ä½ - å¯ä»¥å®ç°</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label class="form-label">
                                8. ä½¿ç”¨é¢‘ç‡
                                <span class="required">*</span>
                            </label>
                            <select class="form-select" id="q8_frequency" required>
                                <option value="">è¯·é€‰æ‹©ä½¿ç”¨é¢‘ç‡</option>
                                <option value="daily">æ¯å¤©å¤šæ¬¡</option>
                                <option value="weekly">æ¯å‘¨å‡ æ¬¡</option>
                                <option value="monthly">æ¯æœˆå‡ æ¬¡</option>
                                <option value="occasional">å¶å°”ä½¿ç”¨</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label class="form-label">
                                9. é¢„æœŸçš„ä¸šåŠ¡ä»·å€¼æˆ–æ”¶ç›Š
                            </label>
                            <textarea class="form-textarea" id="q9_expected_value"
                                      placeholder="æè¿°é¢„æœŸå¸¦æ¥çš„ä¸šåŠ¡ä»·å€¼"></textarea>
                        </div>

                        <div class="form-group">
                            <label class="form-label">
                                10. å¦‚ä½•è¡¡é‡æˆåŠŸï¼Ÿ
                            </label>
                            <textarea class="form-textarea" id="q10_success_metrics"
                                      placeholder="åˆ—å‡ºå¯é‡åŒ–çš„æˆåŠŸæŒ‡æ ‡"></textarea>
                        </div>
                    </div>

                    <div class="button-group">
                        <button type="submit" class="btn btn-primary">
                            ç”Ÿæˆç”¨æˆ·æ•…äº‹ â†’
                        </button>
                    </div>
                </form>
            </div>

            <!-- Step 2: User Story -->
            <div class="section" id="step2">
                <div class="story-card">
                    <div class="story-title" id="storyTitle">ç”¨æˆ·æ•…äº‹æ ‡é¢˜</div>

                    <div class="story-section">
                        <div class="story-section-title">
                            <span class="icon">ğŸ‘¤</span>
                            è§’è‰² (Role)
                        </div>
                        <div class="story-content" id="storyRole">-</div>
                    </div>

                    <div class="story-section">
                        <div class="story-section-title">
                            <span class="icon">âš¡</span>
                            è¡ŒåŠ¨ (Action)
                        </div>
                        <div class="story-content" id="storyAction">-</div>
                    </div>

                    <div class="story-section">
                        <div class="story-section-title">
                            <span class="icon">ğŸ’</span>
                            ä»·å€¼ (Benefit)
                        </div>
                        <div class="story-content" id="storyBenefit">-</div>
                    </div>

                    <div class="story-section">
                        <div class="story-section-title">
                            <span class="icon">âœ…</span>
                            éªŒæ”¶æ ‡å‡† (Acceptance Criteria)
                        </div>
                        <ul class="acceptance-criteria" id="storyAcceptanceCriteria">
                            <li>æš‚æ— éªŒæ”¶æ ‡å‡†</li>
                        </ul>
                    </div>
                </div>

                <div class="button-group">
                    <button class="btn btn-secondary" id="editStoryBtn">
                        â† è¿”å›ä¿®æ”¹
                    </button>
                    <button class="btn btn-success" id="startInvestBtn">
                        å¼€å§‹ INVEST åˆ†æ â†’
                    </button>
                </div>
            </div>

            <!-- Step 3: INVEST Analysis -->
            <div class="section" id="step3">
                <div class="invest-container">
                    <div class="invest-controls">
                        <h3 style="margin-bottom: 20px; color: rgba(0, 0, 0, 0.88);">
                            ğŸ“Š INVEST è¯„åˆ†
                        </h3>

                        <div class="invest-slider-group">
                            <div class="invest-slider-label">
                                <span>Independent<br><small>ç‹¬ç«‹æ€§</small></span>
                                <span class="invest-slider-value" id="independentValue">70</span>
                            </div>
                            <input type="range" class="invest-slider" id="independent" min="0" max="100" value="70">
                        </div>

                        <div class="invest-slider-group">
                            <div class="invest-slider-label">
                                <span>Negotiable<br><small>å¯åå•†æ€§</small></span>
                                <span class="invest-slider-value" id="negotiableValue">70</span>
                            </div>
                            <input type="range" class="invest-slider" id="negotiable" min="0" max="100" value="70">
                        </div>

                        <div class="invest-slider-group">
                            <div class="invest-slider-label">
                                <span>Valuable<br><small>ä»·å€¼æ€§</small></span>
                                <span class="invest-slider-value" id="valuableValue">70</span>
                            </div>
                            <input type="range" class="invest-slider" id="valuable" min="0" max="100" value="70">
                        </div>

                        <div class="invest-slider-group">
                            <div class="invest-slider-label">
                                <span>Estimable<br><small>å¯ä¼°ç®—æ€§</small></span>
                                <span class="invest-slider-value" id="estimableValue">70</span>
                            </div>
                            <input type="range" class="invest-slider" id="estimable" min="0" max="100" value="70">
                        </div>

                        <div class="invest-slider-group">
                            <div class="invest-slider-label">
                                <span>Small<br><small>å°å‹</small></span>
                                <span class="invest-slider-value" id="smallValue">70</span>
                            </div>
                            <input type="range" class="invest-slider" id="small" min="0" max="100" value="70">
                        </div>

                        <div class="invest-slider-group">
                            <div class="invest-slider-label">
                                <span>Testable<br><small>å¯æµ‹è¯•æ€§</small></span>
                                <span class="invest-slider-value" id="testableValue">70</span>
                            </div>
                            <input type="range" class="invest-slider" id="testable" min="0" max="100" value="70">
                        </div>
                    </div>

                    <div class="invest-visualization">
                        <div class="radar-chart-container">
                            <canvas id="radarChart"></canvas>
                        </div>

                        <div class="invest-score-display">
                            <div class="total-score" id="totalScore">70</div>
                            <div class="score-label">æ€»åˆ† / 100</div>
                        </div>
                    </div>
                </div>

                <div class="suggestions" id="suggestions">
                    <div class="suggestions-title">ğŸ’¡ æ”¹è¿›å»ºè®®</div>
                    <ul class="suggestions-list" id="suggestionsList">
                        <li>è°ƒæ•´è¯„åˆ†ä»¥è·å–æ”¹è¿›å»ºè®®</li>
                    </ul>
                </div>

                <div class="export-section">
                    <h3>ğŸ“¥ å¯¼å‡ºç»“æœ</h3>
                    <div class="button-group">
                        <button class="btn btn-secondary" id="exportJsonBtn">
                            å¯¼å‡º JSON
                        </button>
                        <button class="btn btn-secondary" id="restartBtn">
                            é‡æ–°å¼€å§‹
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global state
        let ipdData = {};
        let userStory = {};
        let investScores = {
            independent: 70,
            negotiable: 70,
            valuable: 70,
            estimable: 70,
            small: 70,
            testable: 70
        };

        // DOM Elements
        const ipdForm = document.getElementById('ipdForm');
        const editStoryBtn = document.getElementById('editStoryBtn');
        const startInvestBtn = document.getElementById('startInvestBtn');
        const exportJsonBtn = document.getElementById('exportJsonBtn');
        const restartBtn = document.getElementById('restartBtn');
        const radarCanvas = document.getElementById('radarChart');
        const radarCtx = radarCanvas.getContext('2d');

        // Resize canvas for retina displays
        function resizeCanvas() {
            const container = radarCanvas.parentElement;
            const size = Math.min(container.offsetWidth, container.offsetHeight);
            const dpr = window.devicePixelRatio || 1;
            radarCanvas.width = size * dpr;
            radarCanvas.height = size * dpr;
            radarCanvas.style.width = size + 'px';
            radarCanvas.style.height = size + 'px';
            radarCtx.scale(dpr, dpr);
            drawRadarChart();
        }

        // Generate User Story from IPD data
        function generateUserStory(ipd) {
            // Extract role
            let role = ipd.q1_who || 'ç”¨æˆ·';

            // Extract action from ideal solution
            let action = ipd.q6_ideal_solution || 'æ‰§è¡Œæ“ä½œ';
            if (action.length > 100) {
                action = action.substring(0, 100) + '...';
            }

            // Extract benefit from why they care
            let benefit = ipd.q2_why || 'è·å¾—ä»·å€¼';
            if (benefit.length > 100) {
                benefit = benefit.substring(0, 100) + '...';
            }

            // Generate acceptance criteria
            const criteria = [];

            if (ipd.q6_ideal_solution) {
                criteria.push(`ç³»ç»Ÿèƒ½å¤Ÿï¼š${ipd.q6_ideal_solution.substring(0, 50)}...`);
            }

            if (ipd.q7_priority === 'high') {
                criteria.push('åŠŸèƒ½å¿…é¡»ä¼˜å…ˆå®ç°ï¼Œæ— æ›¿ä»£æ–¹æ¡ˆ');
            }

            if (ipd.q8_frequency === 'daily') {
                criteria.push('ç³»ç»Ÿå“åº”æ—¶é—´åº”å°äº2ç§’ï¼ˆé«˜é¢‘ä½¿ç”¨åœºæ™¯ï¼‰');
            } else if (ipd.q8_frequency === 'weekly') {
                criteria.push('ç³»ç»Ÿå“åº”æ—¶é—´åº”å°äº3ç§’');
            }

            if (ipd.q10_success_metrics) {
                criteria.push(`æˆåŠŸæŒ‡æ ‡ï¼š${ipd.q10_success_metrics.substring(0, 40)}...`);
            }

            if (criteria.length === 0) {
                criteria.push('åŠŸèƒ½æ­£å¸¸å·¥ä½œä¸”ç¬¦åˆç”¨æˆ·é¢„æœŸ');
                criteria.push('é€šè¿‡æ‰€æœ‰æµ‹è¯•ç”¨ä¾‹');
                criteria.push('æ€§èƒ½æ»¡è¶³ç³»ç»Ÿè¦æ±‚');
            }

            // Generate title
            const title = `${role}éœ€è¦${action.substring(0, 20)}...`;

            return {
                title,
                role,
                action,
                benefit,
                acceptanceCriteria: criteria
            };
        }

        // Display user story
        function displayUserStory(story) {
            document.getElementById('storyTitle').textContent = story.title;
            document.getElementById('storyRole').textContent = story.role;
            document.getElementById('storyAction').textContent = story.action;
            document.getElementById('storyBenefit').textContent = story.benefit;

            const criteriaList = document.getElementById('storyAcceptanceCriteria');
            criteriaList.innerHTML = '';
            story.acceptanceCriteria.forEach(criteria => {
                const li = document.createElement('li');
                li.textContent = criteria;
                criteriaList.appendChild(li);
            });
        }

        // Draw radar chart
        function drawRadarChart() {
            const size = radarCanvas.width / (window.devicePixelRatio || 1);
            const centerX = size / 2;
            const centerY = size / 2;
            const radius = (size / 2) * 0.7;

            // Clear canvas
            radarCtx.clearRect(0, 0, size, size);

            const labels = ['Independent', 'Negotiable', 'Valuable', 'Estimable', 'Small', 'Testable'];
            const data = [
                investScores.independent,
                investScores.negotiable,
                investScores.valuable,
                investScores.estimable,
                investScores.small,
                investScores.testable
            ];

            const angleStep = (Math.PI * 2) / 6;

            // Draw background grid
            for (let i = 1; i <= 5; i++) {
                radarCtx.beginPath();
                radarCtx.strokeStyle = '#f0f0f0';
                radarCtx.lineWidth = 1;

                for (let j = 0; j < 6; j++) {
                    const angle = j * angleStep - Math.PI / 2;
                    const r = (radius / 5) * i;
                    const x = centerX + r * Math.cos(angle);
                    const y = centerY + r * Math.sin(angle);

                    if (j === 0) {
                        radarCtx.moveTo(x, y);
                    } else {
                        radarCtx.lineTo(x, y);
                    }
                }

                radarCtx.closePath();
                radarCtx.stroke();
            }

            // Draw axes
            for (let i = 0; i < 6; i++) {
                const angle = i * angleStep - Math.PI / 2;
                const x = centerX + radius * Math.cos(angle);
                const y = centerY + radius * Math.sin(angle);

                radarCtx.beginPath();
                radarCtx.strokeStyle = '#d9d9d9';
                radarCtx.moveTo(centerX, centerY);
                radarCtx.lineTo(x, y);
                radarCtx.stroke();

                // Draw labels
                const labelRadius = radius + 20;
                const labelX = centerX + labelRadius * Math.cos(angle);
                const labelY = centerY + labelRadius * Math.sin(angle);

                radarCtx.fillStyle = 'rgba(0, 0, 0, 0.65)';
                radarCtx.font = '11px sans-serif';
                radarCtx.textAlign = 'center';
                radarCtx.textBaseline = 'middle';
                radarCtx.fillText(labels[i], labelX, labelY);
            }

            // Draw data polygon
            radarCtx.beginPath();
            for (let i = 0; i < 6; i++) {
                const angle = i * angleStep - Math.PI / 2;
                const value = data[i] / 100;
                const r = radius * value;
                const x = centerX + r * Math.cos(angle);
                const y = centerY + r * Math.sin(angle);

                if (i === 0) {
                    radarCtx.moveTo(x, y);
                } else {
                    radarCtx.lineTo(x, y);
                }
            }
            radarCtx.closePath();

            // Fill with gradient
            const gradient = radarCtx.createRadialGradient(centerX, centerY, 0, centerX, centerY, radius);
            gradient.addColorStop(0, 'rgba(24, 144, 255, 0.3)');
            gradient.addColorStop(1, 'rgba(24, 144, 255, 0.1)');
            radarCtx.fillStyle = gradient;
            radarCtx.fill();

            radarCtx.strokeStyle = '#1890ff';
            radarCtx.lineWidth = 2;
            radarCtx.stroke();

            // Draw data points
            for (let i = 0; i < 6; i++) {
                const angle = i * angleStep - Math.PI / 2;
                const value = data[i] / 100;
                const r = radius * value;
                const x = centerX + r * Math.cos(angle);
                const y = centerY + r * Math.sin(angle);

                radarCtx.beginPath();
                radarCtx.fillStyle = '#1890ff';
                radarCtx.arc(x, y, 4, 0, Math.PI * 2);
                radarCtx.fill();
            }
        }

        // Calculate total score
        function calculateTotalScore() {
            const scores = Object.values(investScores);
            return Math.round(scores.reduce((a, b) => a + b, 0) / scores.length);
        }

        // Update score display
        function updateScoreDisplay() {
            const total = calculateTotalScore();
            const totalScoreEl = document.getElementById('totalScore');
            totalScoreEl.textContent = total;

            totalScoreEl.classList.remove('excellent', 'good', 'poor');
            if (total >= 80) {
                totalScoreEl.classList.add('excellent');
            } else if (total >= 60) {
                totalScoreEl.classList.add('good');
            } else {
                totalScoreEl.classList.add('poor');
            }
        }

        // Generate suggestions
        function generateSuggestions() {
            const suggestions = [];
            const scores = investScores;

            if (scores.independent < 60) {
                suggestions.push('ç‹¬ç«‹æ€§è¾ƒä½ï¼šå°è¯•å°†éœ€æ±‚æ‹†åˆ†ä¸ºæ›´å°ã€æ›´ç‹¬ç«‹çš„åŠŸèƒ½æ¨¡å—');
            }
            if (scores.negotiable < 60) {
                suggestions.push('å¯åå•†æ€§ä¸è¶³ï¼šä¸å›¢é˜Ÿè®¨è®ºæ˜¯å¦æœ‰æ›¿ä»£æ–¹æ¡ˆæˆ–ç®€åŒ–å®ç°çš„æ–¹å¼');
            }
            if (scores.valuable < 60) {
                suggestions.push('ä»·å€¼æ€§ä¸æ˜ç¡®ï¼šé‡æ–°è¯„ä¼°éœ€æ±‚çš„ä¸šåŠ¡ä»·å€¼å’Œç”¨æˆ·æ”¶ç›Š');
            }
            if (scores.estimable < 60) {
                suggestions.push('å¯ä¼°ç®—æ€§å·®ï¼šéœ€æ±‚å¯èƒ½è¿‡äºæ¨¡ç³Šï¼Œéœ€è¦è¿›ä¸€æ­¥ç»†åŒ–å’Œæ¾„æ¸…');
            }
            if (scores.small < 60) {
                suggestions.push('è§„æ¨¡åå¤§ï¼šè€ƒè™‘å°†éœ€æ±‚æ‹†åˆ†ä¸ºå¤šä¸ªå°çš„ç”¨æˆ·æ•…äº‹');
            }
            if (scores.testable < 60) {
                suggestions.push('å¯æµ‹è¯•æ€§ä¸è¶³ï¼šå®šä¹‰æ˜ç¡®çš„éªŒæ”¶æ ‡å‡†å’Œæµ‹è¯•åœºæ™¯');
            }

            if (suggestions.length === 0) {
                suggestions.push('å„é¡¹æŒ‡æ ‡è¡¨ç°è‰¯å¥½ï¼è¿™æ˜¯ä¸€ä¸ªé«˜è´¨é‡çš„ç”¨æˆ·æ•…äº‹ã€‚');
            }

            const suggestionsList = document.getElementById('suggestionsList');
            suggestionsList.innerHTML = '';
            suggestions.forEach(s => {
                const li = document.createElement('li');
                li.textContent = s;
                suggestionsList.appendChild(li);
            });
        }

        // Switch sections
        function switchSection(sectionNum) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.step').forEach(s => s.classList.remove('active', 'completed'));

            for (let i = 1; i <= sectionNum; i++) {
                const step = document.getElementById(`step${i}-indicator`);
                if (i < sectionNum) {
                    step.classList.add('completed');
                } else {
                    step.classList.add('active');
                }
            }

            document.getElementById(`step${sectionNum}`).classList.add('active');

            if (sectionNum === 3) {
                setTimeout(resizeCanvas, 100);
            }
        }

        // Event Listeners
        ipdForm.addEventListener('submit', function(e) {
            e.preventDefault();

            ipdData = {
                q1_who: document.getElementById('q1_who').value,
                q2_why: document.getElementById('q2_why').value,
                q3_what_problem: document.getElementById('q3_what_problem').value,
                q4_current_solution: document.getElementById('q4_current_solution').value,
                q5_current_issues: document.getElementById('q5_current_issues').value,
                q6_ideal_solution: document.getElementById('q6_ideal_solution').value,
                q7_priority: document.getElementById('q7_priority').value,
                q8_frequency: document.getElementById('q8_frequency').value,
                q9_expected_value: document.getElementById('q9_expected_value').value,
                q10_success_metrics: document.getElementById('q10_success_metrics').value
            };

            userStory = generateUserStory(ipdData);
            displayUserStory(userStory);
            switchSection(2);
        });

        editStoryBtn.addEventListener('click', function() {
            switchSection(1);
        });

        startInvestBtn.addEventListener('click', function() {
            switchSection(3);
            updateScoreDisplay();
            generateSuggestions();
        });

        // INVEST sliders
        ['independent', 'negotiable', 'valuable', 'estimable', 'small', 'testable'].forEach(dim => {
            const slider = document.getElementById(dim);
            const valueDisplay = document.getElementById(dim + 'Value');

            slider.addEventListener('input', function() {
                investScores[dim] = parseInt(this.value);
                valueDisplay.textContent = this.value;
                drawRadarChart();
                updateScoreDisplay();
                generateSuggestions();
            });
        });

        // Export JSON
        exportJsonBtn.addEventListener('click', function() {
            const exportData = {
                ipdData: ipdData,
                userStory: userStory,
                investAnalysis: {
                    scores: investScores,
                    totalScore: calculateTotalScore(),
                    timestamp: new Date().toISOString()
                }
            };

            const json = JSON.stringify(exportData, null, 2);
            const blob = new Blob([json], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `ipd-story-flow-${Date.now()}.json`;
            a.click();
            URL.revokeObjectURL(url);
        });

        // Restart
        restartBtn.addEventListener('click', function() {
            if (confirm('ç¡®å®šè¦é‡æ–°å¼€å§‹å—ï¼Ÿå½“å‰æ•°æ®å°†ä¸¢å¤±ã€‚')) {
                ipdForm.reset();
                ipdData = {};
                userStory = {};
                investScores = {
                    independent: 70,
                    negotiable: 70,
                    valuable: 70,
                    estimable: 70,
                    small: 70,
                    testable: 70
                };

                ['independent', 'negotiable', 'valuable', 'estimable', 'small', 'testable'].forEach(dim => {
                    document.getElementById(dim).value = 70;
                    document.getElementById(dim + 'Value').textContent = '70';
                });

                switchSection(1);
            }
        });

        // Handle window resize
        window.addEventListener('resize', function() {
            if (document.getElementById('step3').classList.contains('active')) {
                resizeCanvas();
            }
        });

        // Initial draw
        window.addEventListener('load', function() {
            resizeCanvas();
        });
    </script>
</body>
</html>
