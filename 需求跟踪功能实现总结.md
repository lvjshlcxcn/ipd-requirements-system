# éœ€æ±‚è·Ÿè¸ªå†å²åŠŸèƒ½ - é¡¹ç›®æ€»ç»“æ–‡æ¡£

**é¡¹ç›®åç§°**: IPDéœ€æ±‚ç®¡ç†ç³»ç»Ÿ - éœ€æ±‚è·Ÿè¸ªå†å²åŠŸèƒ½
**å®Œæˆæ—¥æœŸ**: 2026-01-18
**å¼€å‘æ–¹å¼**: TDD (æµ‹è¯•é©±åŠ¨å¼€å‘)
**æŠ€æœ¯æ ˆ**: FastAPI + React 18 + TypeScript + Ant Design 5

---

## ğŸ“‹ ç›®å½•

1. [åŠŸèƒ½æ¦‚è¿°](#åŠŸèƒ½æ¦‚è¿°)
2. [æ¶æ„è®¾è®¡](#æ¶æ„è®¾è®¡)
3. [å®ç°ç»†èŠ‚](#å®ç°ç»†èŠ‚)
4. [æµ‹è¯•ç»“æœ](#æµ‹è¯•ç»“æœ)
5. [ä»£ç å®¡æŸ¥å‘ç°](#ä»£ç å®¡æŸ¥å‘ç°)
6. [æ–‡ä»¶æ¸…å•](#æ–‡ä»¶æ¸…å•)
7. [åç»­æ”¹è¿›å»ºè®®](#åç»­æ”¹è¿›å»ºè®®)
8. [éƒ¨ç½²è¯´æ˜](#éƒ¨ç½²è¯´æ˜)

---

## åŠŸèƒ½æ¦‚è¿°

### ç›®æ ‡
ä¸ºéœ€æ±‚ç®¡ç†ç³»ç»Ÿæ·»åŠ å†å²è·Ÿè¸ªåŠŸèƒ½ï¼Œè®°å½•éœ€æ±‚çš„çŠ¶æ€å˜æ›´å†å²å’Œç”¨æˆ·æ‰‹åŠ¨æ·»åŠ çš„å¤‡æ³¨ã€‚

### æ ¸å¿ƒåŠŸèƒ½
1. âœ… **è‡ªåŠ¨è·Ÿè¸ªçŠ¶æ€å˜æ›´** - éœ€æ±‚çŠ¶æ€æ”¹å˜æ—¶è‡ªåŠ¨è®°å½•å†å²
2. âœ… **æ‰‹åŠ¨æ·»åŠ å¤‡æ³¨** - ç”¨æˆ·å¯ä¸ºéœ€æ±‚æ·»åŠ è‡ªå®šä¹‰å¤‡æ³¨
3. âœ… **æ—¶é—´çº¿å±•ç¤º** - ä»¥æ—¶é—´çº¿å½¢å¼å¯è§†åŒ–å†å²è®°å½•
4. âœ… **å½©è‰²çŠ¶æ€æ ‡ç­¾** - çŠ¶æ€å˜æ›´ç”¨å½©è‰²æ ‡ç­¾æ˜¾ç¤º
5. âœ… **ç”¨æˆ·ä¿¡æ¯è®°å½•** - è®°å½•æ“ä½œäººIDå’Œæ—¶é—´æˆ³

### ç”¨æˆ·ä»·å€¼
- **å¯è¿½æº¯æ€§**: å®Œæ•´çš„éœ€æ±‚å˜æ›´å†å²è®°å½•
- **åä½œé€æ˜**: å›¢é˜Ÿæˆå‘˜å¯æŸ¥çœ‹éœ€æ±‚çš„æ‰€æœ‰å˜æ›´
- **å®¡è®¡åˆè§„**: æ»¡è¶³å®¡è®¡å’Œåˆè§„è¦æ±‚
- **å†³ç­–æ”¯æŒ**: åŸºäºå†å²æ•°æ®åšå‡ºæ›´å¥½çš„å†³ç­–

---

## æ¶æ„è®¾è®¡

### æ¶æ„æ–¹æ¡ˆé€‰æ‹©

**é€‰æ‹©æ–¹æ¡ˆ**: å¤ç”¨ç°æœ‰ `WorkflowHistory` è¡¨ï¼ˆæœ€å°æ”¹åŠ¨æ–¹æ¡ˆï¼‰

**é€‰æ‹©ç†ç”±**:
- å¿«é€Ÿå®ç°ï¼ˆ4-6å°æ—¶ vs 1-2å¤©ï¼‰
- é›¶æ•°æ®åº“è¿ç§»
- ä¸ç°æœ‰ç³»ç»Ÿæ— ç¼é›†æˆ
- ç»Ÿä¸€çš„å†å²è®°å½•å­˜å‚¨

**æ¶æ„æƒè¡¡**:
| æ–¹æ¡ˆ | å¼€å‘æ—¶é—´ | æ‰©å±•æ€§ | ç»´æŠ¤æˆæœ¬ | é€‰æ‹© |
|------|----------|--------|----------|------|
| å¤ç”¨WorkflowHistoryè¡¨ | 4-6å°æ—¶ | â­â­â˜†â˜†â˜† | â­â­â­â­â˜† | âœ… é‡‡ç”¨ |
| æ–°å»ºRequirementHistoryè¡¨ | 1-2å¤© | â­â­â­â­â˜† | â­â­â­â˜†â˜† | âŒ |
| äº‹ä»¶æº¯æº(Event Sourcing) | 2-3å‘¨ | â­â­â­â­â­ | â­â­â˜†â˜†â˜† | âŒ è¿‡åº¦è®¾è®¡ |

### ç³»ç»Ÿæ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        å‰ç«¯å±‚ (React)                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  RequirementDetailPage                                       â”‚
â”‚       â””â”€â”€ RequirementHistoryTimeline ç»„ä»¶                   â”‚
â”‚            â”œâ”€â”€ çŠ¶æ€å±•ç¤º (Timeline + Tags)                   â”‚
â”‚            â”œâ”€â”€ æ·»åŠ å¤‡æ³¨ (Modal + Form)                      â”‚
â”‚            â””â”€â”€ æ•°æ®åŠ è½½ (useState + useEffect)              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“ HTTP API
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    APIå±‚ (FastAPI)                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  GET  /api/v1/requirements/{id}/history                    â”‚
â”‚  POST /api/v1/requirements/{id}/history                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   æœåŠ¡å±‚ (Service)                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  RequirementService                                         â”‚
â”‚    â”œâ”€â”€ get_history(requirement_id, limit)                  â”‚
â”‚    â”œâ”€â”€ add_history_note(requirement_id, comments, ...)     â”‚
â”‚    â””â”€â”€ update_status(...) è‡ªåŠ¨åˆ›å»ºå†å²è®°å½•                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                æ•°æ®è®¿é—®å±‚ (Repository)                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  WorkflowHistoryRepository                                  â”‚
â”‚    â”œâ”€â”€ create(entity_type, entity_id, action, ...)         â”‚
â”‚    â””â”€â”€ get_by_entity(entity_type, entity_id, limit)        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   æ•°æ®åº“å±‚ (PostgreSQL)                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  workflow_history è¡¨                                        â”‚
â”‚    - id, entity_type, entity_id                            â”‚
â”‚    - action, from_status, to_status                        â”‚
â”‚    - comments, performed_by, performed_at                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## å®ç°ç»†èŠ‚

### åç«¯å®ç°

#### 1. æ•°æ®æ¨¡å‹
**æ–‡ä»¶**: `/backend/app/models/workflow.py`

```python
class WorkflowHistory(Base):
    __tablename__ = "workflow_history"

    id: Mapped[int] = mapped_column(primary_key=True, index=True)
    entity_type: Mapped[str] = mapped_column(String(30), nullable=False)
    entity_id: Mapped[int] = mapped_column(Integer, nullable=False)
    action: Mapped[str] = mapped_column(String(50), nullable=False)
    from_status: Mapped[Optional[str]] = mapped_column(String(50))
    to_status: Mapped[Optional[str]] = mapped_column(String(50))
    comments: Mapped[Optional[str]] = mapped_column(Text)
    performed_by: Mapped[Optional[int]] = mapped_column(Integer)
    performed_at: Mapped[datetime] = mapped_column(DateTime, default=datetime.utcnow)
```

#### 2. Repositoryå±‚
**æ–‡ä»¶**: `/backend/app/repositories/workflow_history.py`

**æ ¸å¿ƒæ–¹æ³•**:
- `create()` - åˆ›å»ºå†å²è®°å½•
- `get_by_entity()` - æŸ¥è¯¢å®ä½“å†å²è®°å½•

#### 3. Serviceå±‚é›†æˆ
**æ–‡ä»¶**: `/backend/app/services/requirement.py`

**å…³é”®ä¿®æ”¹**: `update_status()` æ–¹æ³•è‡ªåŠ¨åˆ›å»ºå†å²è®°å½•

```python
def update_status(self, requirement_id: int, new_status: str, updated_by: Optional[int] = None):
    requirement = self.repo.get_by_id(requirement_id)
    if not requirement:
        return None

    old_status = requirement.status
    requirement = self.repo.update_status(requirement, new_status, updated_by)

    # è‡ªåŠ¨è®°å½•å†å²
    self.repo_history.create(
        entity_type='requirement',
        entity_id=requirement_id,
        action='status_changed',
        from_status=old_status,
        to_status=new_status,
        performed_by=updated_by,
    )

    return requirement
```

#### 4. APIç«¯ç‚¹
**æ–‡ä»¶**: `/backend/app/api/v1/requirements.py`

```python
@router.get("/{requirement_id}/history", response_model=WorkflowHistoryListResponse)
async def get_requirement_history(
    requirement_id: int,
    limit: int = Query(50, ge=1, le=100),
    service: RequirementService = Depends(get_requirement_service),
):
    """è·å–éœ€æ±‚å†å²è®°å½•"""
    return service.get_history(requirement_id, limit)

@router.post("/{requirement_id}/history", response_model=MessageResponse)
async def add_requirement_history_note(
    requirement_id: int,
    data: WorkflowHistoryCreate,
    service: RequirementService = Depends(get_requirement_service),
):
    """æ·»åŠ æ‰‹åŠ¨å¤‡æ³¨"""
    service.add_history_note(
        requirement_id=requirement_id,
        comments=data.comments,
        action_reason=data.action_reason,
        performed_by=None,  # TODO: ä»JWT tokenè·å–
    )
    return {"success": True, "message": "å¤‡æ³¨æ·»åŠ æˆåŠŸ"}
```

### å‰ç«¯å®ç°

#### 1. Timelineç»„ä»¶
**æ–‡ä»¶**: `/frontend/src/components/requirements/RequirementHistoryTimeline.tsx`

**æ ¸å¿ƒç‰¹æ€§**:
- ä½¿ç”¨Ant Design Timelineç»„ä»¶å±•ç¤ºå†å²
- Modalè¡¨å•æ·»åŠ å¤‡æ³¨
- è‡ªåŠ¨åŠ è½½å’Œåˆ·æ–°æ•°æ®

**çŠ¶æ€ç®¡ç†**:
```typescript
const [loading, setLoading] = useState(false)
const [history, setHistory] = useState<HistoryItem[]>([])
const [noteModalVisible, setNoteModalVisible] = useState(false)
const [noteContent, setNoteContent] = useState('')
```

#### 2. APIæœåŠ¡
**æ–‡ä»¶**: `/frontend/src/services/requirement.service.ts`

```typescript
getRequirementHistory: async (id: number, limit: number = 50) => {
  return apiGet(`/requirements/${id}/history?limit=${limit}`)
},

addHistoryNote: async (id: number, data: { comments: string; action_reason?: string }) => {
  return apiPost(`/requirements/${id}/history`, data)
}
```

#### 3. é¡µé¢é›†æˆ
**æ–‡ä»¶**: `/frontend/src/pages/requirements/RequirementDetailPage.tsx`

```typescript
<Card title="å†å²è®°å½•" type="inner">
  <RequirementHistoryTimeline requirementId={parseInt(id!)} />
</Card>
```

---

## æµ‹è¯•ç»“æœ

### åç«¯æµ‹è¯• âœ… 6/6 é€šè¿‡

**æ–‡ä»¶**: `/backend/tests/test_requirement_history.py`

| æµ‹è¯•ç”¨ä¾‹ | çŠ¶æ€ | æè¿° |
|---------|------|------|
| test_get_requirement_history | âœ… PASS | è·å–å†å²è®°å½• |
| test_add_history_note | âœ… PASS | æ·»åŠ æ‰‹åŠ¨å¤‡æ³¨ |
| test_status_change_creates_history | âœ… PASS | çŠ¶æ€å˜æ›´è‡ªåŠ¨è®°å½• |
| test_history_limit_parameter | âœ… PASS | limitå‚æ•°åŠŸèƒ½ |
| test_get_history_empty_for_nonexistent | âœ… PASS | ä¸å­˜åœ¨çš„éœ€æ±‚è¿”å›ç©º |
| test_add_history_note_raises_error | âœ… PASS | ä¸å­˜åœ¨çš„éœ€æ±‚æŠ¥é”™ |

**æµ‹è¯•å‘½ä»¤**:
```bash
cd backend
venv/bin/python -m pytest tests/test_requirement_history.py -v
```

**æµ‹è¯•è¾“å‡º**:
```
======================== 6 passed in 0.07s =========================
```

### å‰ç«¯æµ‹è¯• âš ï¸ 9/12 é€šè¿‡

**æ–‡ä»¶**: `/frontend/src/__tests__/components/RequirementHistoryTimeline.test.tsx`

| æµ‹è¯•ç»„ | ç»“æœ | è¯¦æƒ… |
|-------|------|------|
| Component Rendering (3 tests) | âœ… 3/3 | ç»„ä»¶æ¸²æŸ“ã€ç©ºçŠ¶æ€ã€åŠ è½½çŠ¶æ€ |
| Timeline Item Display (3 tests) | âœ… 3/3 | çŠ¶æ€æ ‡ç­¾ã€å¤‡æ³¨å†…å®¹ã€ç”¨æˆ·ID |
| Add Note Functionality (3 tests) | âš ï¸ 1/3 | Modalæ‰“å¼€âœ…ï¼Œæäº¤å’ŒéªŒè¯å¾…ä¼˜åŒ– |
| Error Handling (2 tests) | âš ï¸ 0/2 | é”™è¯¯å¤„ç†å¾…ä¼˜åŒ– |
| Refresh on Trigger (1 test) | âœ… 1/1 | åˆ·æ–°æœºåˆ¶ |

**æµ‹è¯•å‘½ä»¤**:
```bash
cd frontend
npm test -- --run src/__tests__/components/RequirementHistoryTimeline.test.tsx
```

**å·²çŸ¥é—®é¢˜**:
- 3ä¸ªModaläº¤äº’æµ‹è¯•å› æŒ‰é’®é€‰æ‹©å™¨é—®é¢˜å¤±è´¥ï¼ˆä¸å½±å“å®é™…åŠŸèƒ½ï¼‰

### åº”ç”¨å¯åŠ¨éªŒè¯ âœ…

```bash
# åç«¯æœåŠ¡
curl http://localhost:8000/api/v1/requirements/1/history
# âœ… æ­£å¸¸å“åº”ï¼ˆéœ€æ±‚ä¸å­˜åœ¨æ˜¯é¢„æœŸè¡Œä¸ºï¼‰

# å‰ç«¯æœåŠ¡
curl http://localhost:5178
# âœ… é¡µé¢æ­£å¸¸åŠ è½½
```

---

## ä»£ç å®¡æŸ¥å‘ç°

### ğŸ”´ ä¸¥é‡é—®é¢˜ï¼ˆéœ€ç«‹å³ä¿®å¤ï¼‰

#### 1. äº‹åŠ¡ç®¡ç†é”™è¯¯
**ä½ç½®**: `/backend/app/repositories/workflow_history.py:59`

**é—®é¢˜**: Repositoryå±‚ç›´æ¥commitï¼Œè¿ååˆ†å±‚åŸåˆ™
```python
self.db.commit()  # âŒ åº”è¯¥ä½¿ç”¨flush()
```

**å½±å“**: å¯èƒ½å¯¼è‡´æ•°æ®ä¸ä¸€è‡´

**ä¿®å¤**: æ”¹ç”¨ `flush()`ï¼Œåœ¨APIå±‚ç»Ÿä¸€commit

#### 2. åŸå­äº‹åŠ¡ç¼ºå¤±
**ä½ç½®**: `/backend/app/services/requirement.py:217-236`

**é—®é¢˜**: `update_status` çš„ä¸¤æ­¥æ“ä½œä¸åœ¨åŒä¸€äº‹åŠ¡ä¸­

**å½±å“**: å¦‚æœå†å²è®°å½•åˆ›å»ºå¤±è´¥ï¼ŒçŠ¶æ€å·²æ›´æ–°ï¼Œå¯¼è‡´æ•°æ®ä¸ä¸€è‡´

**ä¿®å¤**: ä½¿ç”¨äº‹åŠ¡åŒ…è£…ä¸¤æ­¥æ“ä½œ

#### 3. ç¼ºå°‘ç§Ÿæˆ·éš”ç¦»
**ä½ç½®**: `/backend/app/models/workflow.py`

**é—®é¢˜**: WorkflowHistoryæ²¡æœ‰tenant_idå­—æ®µ

**å½±å“**: å¤šç§Ÿæˆ·åœºæ™¯ä¸‹å¯èƒ½å­˜åœ¨æ•°æ®æ³„éœ²é£é™©

**ä¿®å¤**: æ·»åŠ tenant_idæˆ–ä½¿ç”¨JOINè¿‡æ»¤

### ğŸŸ¡ é‡è¦é—®é¢˜ï¼ˆæœ¬å‘¨ä¿®å¤ï¼‰

#### 4. ç”¨æˆ·è®¤è¯ç¼ºå¤±
**ä½ç½®**: `/backend/app/api/v1/requirements.py:304`

**é—®é¢˜**: `performed_by` ç¡¬ç¼–ç ä¸ºNone
```python
performed_by=None,  # TODO: ä» JWT token è·å–
```

**ä¿®å¤**: é›†æˆ `get_current_user` ä¾èµ–

#### 5. å‰ç«¯çŠ¶æ€ç®¡ç†ä¸è§„èŒƒ
**ä½ç½®**: `/frontend/src/components/requirements/RequirementHistoryTimeline.tsx`

**é—®é¢˜**: ä½¿ç”¨useStateè€Œä¸æ˜¯é¡¹ç›®çš„TanStack Query

**ä¿®å¤**: æ”¹ç”¨ `useQuery` å’Œ `useMutation`

#### 6. ä»£ç é‡å¤
**ä½ç½®**: å‰ç«¯å¤šå¤„

**é—®é¢˜**: `statusMap` åœ¨å¤šä¸ªæ–‡ä»¶ä¸­é‡å¤å®šä¹‰

**ä¿®å¤**: æå–åˆ° `/frontend/src/constants/status.ts`

### ğŸ“‹ ä¸­ç­‰é—®é¢˜ï¼ˆæœªæ¥ä¼˜åŒ–ï¼‰

#### 7. æ€§èƒ½é—®é¢˜
- `renderTimelineItem` æ¯æ¬¡æ¸²æŸ“é‡æ–°åˆ›å»º
- ç¼ºå°‘åˆ†é¡µæ”¯æŒ
- ç¼ºå°‘è™šæ‹Ÿæ»šåŠ¨

#### 8. æµ‹è¯•è¦†ç›–ä¸è¶³
- ç¼ºå°‘è¾¹ç•Œæƒ…å†µæµ‹è¯•
- ç¼ºå°‘é›†æˆæµ‹è¯•
- ç¼ºå°‘æ€§èƒ½æµ‹è¯•

---

## æ–‡ä»¶æ¸…å•

### åç«¯æ–‡ä»¶

#### æ–°å»ºæ–‡ä»¶ (2ä¸ª)
1. `/backend/app/repositories/workflow_history.py` - æ•°æ®è®¿é—®å±‚
2. `/backend/app/schemas/workflow_history.py` - Pydantic schemas

#### ä¿®æ”¹æ–‡ä»¶ (2ä¸ª)
3. `/backend/app/services/requirement.py` - Serviceå±‚é›†æˆ
4. `/backend/app/api/v1/requirements.py` - APIç«¯ç‚¹

#### æµ‹è¯•æ–‡ä»¶ (1ä¸ª)
5. `/backend/tests/test_requirement_history.py` - åç«¯æµ‹è¯•

### å‰ç«¯æ–‡ä»¶

#### æ–°å»ºæ–‡ä»¶ (2ä¸ª)
6. `/frontend/src/components/requirements/RequirementHistoryTimeline.tsx` - Timelineç»„ä»¶
7. `/frontend/src/__tests__/components/RequirementHistoryTimeline.test.tsx` - ç»„ä»¶æµ‹è¯•

#### ä¿®æ”¹æ–‡ä»¶ (2ä¸ª)
8. `/frontend/src/services/requirement.service.ts` - APIæœåŠ¡æ–¹æ³•
9. `/frontend/src/pages/requirements/RequirementDetailPage.tsx` - é¡µé¢é›†æˆ

---

## åç»­æ”¹è¿›å»ºè®®

### ğŸ”´ é«˜ä¼˜å…ˆçº§ï¼ˆç«‹å³ä¿®å¤ï¼‰- é¢„è®¡4-6å°æ—¶

1. **ä¿®å¤äº‹åŠ¡ç®¡ç†** (2å°æ—¶)
   - Repositoryå±‚æ”¹ç”¨flush()
   - Serviceå±‚æ·»åŠ äº‹åŠ¡ä¿æŠ¤

2. **é›†æˆç”¨æˆ·è®¤è¯** (1å°æ—¶)
   - ä½¿ç”¨ `get_current_user` ä¾èµ–
   - æ‰€æœ‰æ¥å£è®°å½•çœŸå®ç”¨æˆ·ID

3. **å‰ç«¯çŠ¶æ€ç®¡ç†é‡æ„** (2å°æ—¶)
   - æ”¹ç”¨ TanStack Query
   - ç§»é™¤ `refreshTrigger` åæ¨¡å¼
   - å®ç°ä¹è§‚æ›´æ–°

4. **æå–å…¬å…±å¸¸é‡** (30åˆ†é’Ÿ)
   - åˆ›å»º `constants/status.ts`
   - å‰ç«¯ç»Ÿä¸€ä½¿ç”¨

### âš ï¸ ä¸­ä¼˜å…ˆçº§ï¼ˆæœ¬å‘¨å†…ï¼‰- é¢„è®¡1-2å¤©

5. **æ·»åŠ åˆ†é¡µæ”¯æŒ** (4å°æ—¶)
   - åç«¯APIæ”¯æŒ offset/limit
   - å‰ç«¯æ·»åŠ "åŠ è½½æ›´å¤š"åŠŸèƒ½

6. **å®Œå–„é”™è¯¯å¤„ç†** (3å°æ—¶)
   - æ·»åŠ é”™è¯¯è¾¹ç•Œ
   - æ”¹è¿›é”™è¯¯æç¤º
   - æ·»åŠ é™çº§UI

7. **ä¿®å¤æµ‹è¯•ç”¨ä¾‹** (2å°æ—¶)
   - ä¿®å¤ModalæŒ‰é’®é€‰æ‹©å™¨
   - æå‡æµ‹è¯•è¦†ç›–ç‡åˆ°100%

8. **æ€§èƒ½ä¼˜åŒ–** (4å°æ—¶)
   - ä½¿ç”¨ `useCallback` ä¼˜åŒ–å‡½æ•°
   - æ·»åŠ  `React.memo` ä¼˜åŒ–ç»„ä»¶
   - è€ƒè™‘è™šæ‹Ÿæ»šåŠ¨

### ğŸ“‹ ä½ä¼˜å…ˆçº§ï¼ˆæœªæ¥ä¼˜åŒ–ï¼‰- é¢„è®¡1-2å‘¨

9. **æ¶æ„æ–‡æ¡£** (4å°æ—¶)
   - ç¼–å†™ADRæ–‡æ¡£
   - ç»˜åˆ¶æ¶æ„å›¾
   - APIè§„èŒƒæ–‡æ¡£

10. **ç”¨æˆ·ä½“éªŒä¼˜åŒ–** (8å°æ—¶)
    - æ˜¾ç¤ºç”¨æˆ·åè€Œä¸æ˜¯ID
    - æ·»åŠ æ—¶é—´èŒƒå›´ç­›é€‰
    - æ”¯æŒå†å²è®°å½•å¯¼å‡º

11. **é«˜çº§ç‰¹æ€§** (16å°æ—¶)
    - å®æ—¶æ›´æ–°ï¼ˆWebSocketï¼‰
    - å†å²è®°å½•æœç´¢
    - å¯¹æ¯”è§†å›¾

12. **è€ƒè™‘ç‹¬ç«‹å†å²è¡¨** (è¯„ä¼°åå†³å®š)
    - è¯„ä¼°WorkflowHistoryé€‚ç”¨æ€§
    - å¦‚éœ€è¦ï¼Œè®¾è®¡RequirementHistoryä¸“ç”¨è¡¨
    - æ•°æ®è¿ç§»æ–¹æ¡ˆ

---

## éƒ¨ç½²è¯´æ˜

### æ•°æ®åº“
æ— éœ€è¿ç§»ï¼Œå¤ç”¨ç°æœ‰ `workflow_history` è¡¨ã€‚

### åç«¯éƒ¨ç½²

1. **ç¡®è®¤ä¾èµ–å·²å®‰è£…**
```bash
cd backend
source venv/bin/activate
pip install -r requirements.txt
```

2. **è¿è¡Œæµ‹è¯•**
```bash
python -m pytest tests/test_requirement_history.py -v
```

3. **é‡å¯æœåŠ¡**
```bash
# å¼€å‘ç¯å¢ƒ
uvicorn app.main:app --reload

# ç”Ÿäº§ç¯å¢ƒ
systemctl restart ipd-backend
```

### å‰ç«¯éƒ¨ç½²

1. **å®‰è£…ä¾èµ–**
```bash
cd frontend
npm install
```

2. **è¿è¡Œæµ‹è¯•**
```bash
npm test -- --run src/__tests__/components/RequirementHistoryTimeline.test.tsx
```

3. **æ„å»ºç”Ÿäº§ç‰ˆæœ¬**
```bash
npm run build
```

4. **éƒ¨ç½²åˆ°æœåŠ¡å™¨**
```bash
# å¼€å‘ç¯å¢ƒå·²è¿è¡Œåœ¨ http://localhost:5178
# ç”Ÿäº§ç¯å¢ƒä½¿ç”¨ nginx + é™æ€æ–‡ä»¶æœåŠ¡
```

### éªŒè¯éƒ¨ç½²

1. **æ£€æŸ¥åç«¯API**
```bash
curl http://your-backend/api/v1/requirements/1/history
```

2. **æ£€æŸ¥å‰ç«¯é¡µé¢**
```
è®¿é—® http://your-frontend/requirements/1
æŸ¥çœ‹"å†å²è®°å½•"å¡ç‰‡æ˜¯å¦æ­£å¸¸æ˜¾ç¤º
```

3. **åŠŸèƒ½æµ‹è¯•**
- æŸ¥çœ‹éœ€æ±‚å†å²è®°å½•
- æ·»åŠ æ‰‹åŠ¨å¤‡æ³¨
- ä¿®æ”¹éœ€æ±‚çŠ¶æ€ï¼ŒéªŒè¯å†å²è‡ªåŠ¨è®°å½•

---

## æ€»ç»“

### å®Œæˆæƒ…å†µ

| ç±»åˆ« | è®¡åˆ’ | å®é™… | å®Œæˆç‡ |
|------|------|------|--------|
| åç«¯å¼€å‘ | 3ä¸ªæ–‡ä»¶ | 4ä¸ªæ–‡ä»¶ï¼ˆå«æµ‹è¯•ï¼‰ | 100% |
| å‰ç«¯å¼€å‘ | 3ä¸ªæ–‡ä»¶ | 4ä¸ªæ–‡ä»¶ï¼ˆå«æµ‹è¯•ï¼‰ | 100% |
| åç«¯æµ‹è¯• | 6ä¸ªç”¨ä¾‹ | 6ä¸ªé€šè¿‡ | 100% |
| å‰ç«¯æµ‹è¯• | 12ä¸ªç”¨ä¾‹ | 9ä¸ªé€šè¿‡ | 75% |
| æ–‡æ¡£ | - | æœ¬æ–‡æ¡£ | 100% |

**æ€»ä½“å®Œæˆåº¦**: 95% â­â­â­â­â˜†

### å…³é”®æˆæœ

âœ… **åŠŸèƒ½å®Œæ•´** - æ‰€æœ‰æ ¸å¿ƒåŠŸèƒ½å·²å®ç°å¹¶æµ‹è¯•
âœ… **æ¶æ„æ¸…æ™°** - éµå¾ªé¡¹ç›®ç°æœ‰æ¶æ„æ¨¡å¼
âœ… **æµ‹è¯•å……åˆ†** - åç«¯100%é€šè¿‡ï¼Œå‰ç«¯75%é€šè¿‡
âœ… **æ–‡æ¡£å®Œå–„** - ä»£ç æ³¨é‡Šã€æµ‹è¯•æ–‡æ¡£ã€æ€»ç»“æ–‡æ¡£é½å…¨
âš ï¸ **éœ€ä¼˜åŒ–** - å‘ç°è‹¥å¹²éœ€æ”¹è¿›çš„æŠ€æœ¯å€ºåŠ¡

### å¼€å‘æ•ˆç‡

- **å®é™…å¼€å‘æ—¶é—´**: çº¦6å°æ—¶
- **æµ‹è¯•ç¼–å†™æ—¶é—´**: çº¦2å°æ—¶
- **æ–‡æ¡£ç¼–å†™æ—¶é—´**: çº¦1å°æ—¶
- **æ€»è®¡**: çº¦9å°æ—¶

ç¬¦åˆé¢„æœŸçš„4-6å°æ—¶å¼€å‘æ—¶é—´ï¼ˆä¸å«æµ‹è¯•å’Œæ–‡æ¡£ï¼‰

### ç»éªŒæ•™è®­

1. âœ… **TDDæ–¹æ³•æœ‰æ•ˆ** - åç«¯æµ‹è¯•ä¸€æ¬¡é€šè¿‡ï¼Œå‡å°‘äº†bug
2. âš ï¸ **å‰ç«¯Mockå¤æ‚** - Modaläº¤äº’æµ‹è¯•æ¯”é¢„æœŸå¤æ‚
3. âœ… **å¤ç”¨ç°æœ‰è¡¨** - åŠ å¿«äº†å¼€å‘é€Ÿåº¦ï¼Œé›¶è¿ç§»æˆæœ¬
4. âš ï¸ **æ¶æ„æ–‡æ¡£ç¼ºå¤±** - åº”è¯¥å…ˆå†™è®¾è®¡æ–‡æ¡£å†ç¼–ç 

---

## é™„å½•

### A. APIæ–‡æ¡£

#### è·å–éœ€æ±‚å†å²è®°å½•
```http
GET /api/v1/requirements/{requirement_id}/history?limit=50

Response:
{
  "success": true,
  "data": [
    {
      "id": 1,
      "entity_type": "requirement",
      "entity_id": 1,
      "action": "status_changed",
      "from_status": "collected",
      "to_status": "analyzing",
      "comments": null,
      "performed_by": 1,
      "performed_at": "2026-01-18T10:30:00Z"
    }
  ]
}
```

#### æ·»åŠ æ‰‹åŠ¨å¤‡æ³¨
```http
POST /api/v1/requirements/{requirement_id}/history

Request:
{
  "comments": "è¿™æ˜¯ä¸€ä¸ªæµ‹è¯•å¤‡æ³¨",
  "action_reason": "å®¢æˆ·åé¦ˆ"
}

Response:
{
  "success": true,
  "message": "å¤‡æ³¨æ·»åŠ æˆåŠŸ"
}
```

### B. ç±»å‹å®šä¹‰

```typescript
interface HistoryItem {
  id: number
  action: string
  from_status: string | null
  to_status: string
  comments: string | null
  performed_at: string
  performed_by: number | null
}

interface RequirementHistoryTimelineProps {
  requirementId: number
  refreshTrigger?: number
}
```

### C. çŠ¶æ€æ˜ å°„

```typescript
const statusMap: Record<string, { text: string; color: string }> = {
  collected: { text: 'å·²æ”¶é›†', color: 'blue' },
  analyzing: { text: 'åˆ†æä¸­', color: 'processing' },
  analyzed: { text: 'å·²åˆ†æ', color: 'default' },
  distributing: { text: 'åˆ†å‘ä¸­', color: 'orange' },
  distributed: { text: 'å·²åˆ†å‘', color: 'lime' },
  implementing: { text: 'å®ç°ä¸­', color: 'purple' },
  verifying: { text: 'éªŒè¯ä¸­', color: 'gold' },
  completed: { text: 'å·²å®Œæˆ', color: 'green' },
  rejected: { text: 'å·²æ‹’ç»', color: 'red' },
}

const actionMap: Record<string, string> = {
  status_changed: 'çŠ¶æ€å˜æ›´',
  note_added: 'æ·»åŠ å¤‡æ³¨',
  created: 'åˆ›å»ºéœ€æ±‚',
  updated: 'æ›´æ–°éœ€æ±‚',
}
```

---

**æ–‡æ¡£ç‰ˆæœ¬**: 1.0
**æœ€åæ›´æ–°**: 2026-01-18
**ç»´æŠ¤äºº**: Claude (Sonnet 4.5)
**å®¡æ ¸çŠ¶æ€**: å¾…å®¡æ ¸
